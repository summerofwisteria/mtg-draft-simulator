<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Draft Tutor ‚Äî Master Limited Drafting</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Cinzel:wght@400;700&family=JetBrains+Mono:wght@400;600&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
:root{--void:#06060c;--abyss:#0c0c18;--obsidian:#12121f;--slate:#1a1a2e;--storm:#242444;--gold:#c9a227;--gold-bright:#e8c84a;--gold-dim:rgba(201,162,39,0.15);--gold-glow:rgba(201,162,39,0.4);--arcane:#7c5cbf;--arcane-bright:#a78bfa;--arcane-dim:rgba(124,92,191,0.12);--aether:#3b82f6;--aether-dim:rgba(59,130,246,0.12);--text-primary:#e8e6f0;--text-secondary:#9896a8;--text-dim:#6b6980;--success:#34d399;--warning:#fbbf24;--danger:#f87171;--info:#60a5fa;--common:#6b7280;--uncommon:#9ca3af;--rare:#c9a227;--mythic:#ea580c;--radius-sm:6px;--radius-md:10px;--radius-lg:16px;--radius-xl:24px}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'Source Sans 3',-apple-system,sans-serif;background:var(--void);color:var(--text-primary);overflow-x:hidden;min-height:100vh;-webkit-font-smoothing:antialiased}
.bg-system{position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 80% 50% at 20% 10%,rgba(124,92,191,0.08),transparent),radial-gradient(ellipse 60% 60% at 80% 90%,rgba(59,130,246,0.06),transparent),radial-gradient(ellipse 50% 40% at 50% 50%,rgba(201,162,39,0.03),transparent)}
.bg-grid{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.03;background-image:linear-gradient(rgba(201,162,39,0.5) 1px,transparent 1px),linear-gradient(90deg,rgba(201,162,39,0.5) 1px,transparent 1px);background-size:60px 60px;mask-image:radial-gradient(ellipse 70% 70% at 50% 50%,black,transparent)}
#root{position:relative;z-index:1;min-height:100vh}
.app-shell{min-height:100vh;padding:1.5rem;max-width:1600px;margin:0 auto}
.masthead{text-align:center;padding:2rem 0 1.5rem;position:relative}
.masthead::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:200px;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dim),var(--gold),var(--gold-dim),transparent)}
.logo{font-family:'Cinzel Decorative',serif;font-size:clamp(2rem,5vw,3.2rem);font-weight:700;letter-spacing:0.04em;background:linear-gradient(135deg,var(--gold-bright) 0%,var(--gold) 40%,var(--arcane-bright) 100%);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 2px 12px var(--gold-glow));margin-bottom:0.25rem}
.tagline{font-family:'JetBrains Mono',monospace;font-size:0.75rem;letter-spacing:0.25em;text-transform:uppercase;color:var(--text-dim)}
.mode-badge{display:inline-flex;align-items:center;gap:0.4rem;margin-top:0.75rem;padding:0.35rem 1rem;border-radius:100px;font-size:0.7rem;font-weight:600;letter-spacing:0.08em;text-transform:uppercase}
.mode-badge.local{border:1px solid var(--arcane-dim);color:var(--arcane-bright);background:var(--arcane-dim)}
.mode-badge.live{border:1px solid rgba(52,211,153,0.2);color:var(--success);background:rgba(52,211,153,0.08)}
.mode-badge.error{border:1px solid rgba(248,113,113,0.2);color:var(--danger);background:rgba(248,113,113,0.08)}
.mode-badge .dot{width:6px;height:6px;border-radius:50%;animation:blink 2s ease-in-out infinite}
.mode-badge.local .dot{background:var(--arcane-bright)}
.mode-badge.live .dot{background:var(--success)}
.mode-badge.error .dot{background:var(--danger);animation:none}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.glass{background:linear-gradient(135deg,rgba(18,18,31,0.85),rgba(12,12,24,0.9));backdrop-filter:blur(16px);border:1px solid rgba(201,162,39,0.08);border-radius:var(--radius-lg)}
.glass-accent{background:linear-gradient(135deg,rgba(18,18,31,0.9),rgba(12,12,24,0.95));backdrop-filter:blur(16px);border:1px solid rgba(201,162,39,0.15);border-radius:var(--radius-lg);box-shadow:0 4px 24px rgba(0,0,0,0.3),inset 0 1px 0 rgba(255,255,255,0.03)}
.setup-layout{max-width:860px;margin:2rem auto 0;animation:fadeUp 0.5s ease-out}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.setup-section{padding:2rem 2.5rem;margin-bottom:1.5rem}
.section-label{font-family:'Cinzel',serif;font-size:1.3rem;color:var(--gold);margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem}
.section-label .icon{font-size:1.1rem;opacity:0.8}
.field{margin-bottom:1.5rem}.field:last-child{margin-bottom:0}
.field-label{display:block;font-size:0.8rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-secondary);margin-bottom:0.6rem}
.field-hint{font-size:0.78rem;color:var(--text-dim);margin-top:0.4rem;line-height:1.4}
.input,.select{width:100%;padding:0.85rem 1rem;background:rgba(0,0,0,0.35);border:1.5px solid rgba(201,162,39,0.12);border-radius:var(--radius-md);color:var(--text-primary);font-size:0.95rem;font-family:inherit;transition:border-color 0.2s,box-shadow 0.2s}
.input:focus,.select:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-dim)}
.select option{background:var(--obsidian);color:var(--text-primary)}
.diff-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem}
.diff-card{padding:1.25rem 0.75rem;text-align:center;border-radius:var(--radius-md);cursor:pointer;transition:all 0.25s ease;border:2px solid transparent;background:rgba(0,0,0,0.3);position:relative;overflow:hidden}
.diff-card:hover{transform:translateY(-2px)}
.diff-card.common{border-color:var(--common)}.diff-card.uncommon{border-color:var(--uncommon)}.diff-card.rare{border-color:var(--rare)}.diff-card.mythic{border-color:var(--mythic)}
.diff-card.active{transform:translateY(-2px) scale(1.02)}
.diff-card.active.common{box-shadow:0 6px 24px rgba(107,114,128,0.3)}.diff-card.active.uncommon{box-shadow:0 6px 24px rgba(156,163,175,0.3)}.diff-card.active.rare{box-shadow:0 6px 24px rgba(201,162,39,0.3)}.diff-card.active.mythic{box-shadow:0 6px 24px rgba(234,88,12,0.35)}
.diff-icon{font-size:1.8rem;margin-bottom:0.4rem}
.diff-name{font-family:'Cinzel',serif;font-size:0.85rem;font-weight:700}
.diff-card.common .diff-name{color:var(--common)}.diff-card.uncommon .diff-name{color:var(--uncommon)}.diff-card.rare .diff-name{color:var(--rare)}
.diff-card.mythic .diff-name{background:linear-gradient(135deg,#ea580c,#dc2626);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.diff-desc{font-size:0.7rem;color:var(--text-dim);margin-top:0.3rem;line-height:1.3}
.toggle-row{display:flex;align-items:center;gap:0.75rem;padding:0.85rem 1rem;background:rgba(0,0,0,0.2);border-radius:var(--radius-md);margin-bottom:0.6rem;cursor:pointer;transition:background 0.2s}
.toggle-row:hover{background:rgba(0,0,0,0.35)}
.toggle-switch{position:relative;width:36px;height:20px;flex-shrink:0}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-track{position:absolute;inset:0;background:rgba(255,255,255,0.1);border-radius:10px;transition:background 0.2s;cursor:pointer}
.toggle-track::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:var(--text-secondary);transition:all 0.2s}
.toggle-switch input:checked+.toggle-track{background:var(--arcane)}
.toggle-switch input:checked+.toggle-track::after{transform:translateX(16px);background:white}
.toggle-text{font-size:0.88rem;color:var(--text-primary)}
.toggle-sub{font-size:0.75rem;color:var(--text-dim);margin-top:0.15rem}
.btn-primary{width:100%;padding:1.1rem 2rem;background:linear-gradient(135deg,var(--gold) 0%,var(--arcane) 100%);color:white;border:none;border-radius:var(--radius-md);font-family:'Cinzel',serif;font-size:1.05rem;font-weight:700;letter-spacing:0.05em;cursor:pointer;transition:all 0.25s;box-shadow:0 4px 20px rgba(201,162,39,0.25);position:relative;overflow:hidden}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(201,162,39,0.35)}
.btn-primary:disabled{opacity:0.4;cursor:not-allowed;transform:none}
.onboard-overlay{position:fixed;inset:0;z-index:1000;background:rgba(6,6,12,0.92);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease}
.onboard-card{max-width:620px;width:92%;padding:2.5rem;text-align:center}
.onboard-title{font-family:'Cinzel Decorative',serif;font-size:1.8rem;color:var(--gold);margin-bottom:1rem}
.onboard-body{font-size:0.95rem;color:var(--text-secondary);line-height:1.6;margin-bottom:2rem}
.onboard-features{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:2rem;text-align:left}
.ob-feat{display:flex;align-items:flex-start;gap:0.6rem;padding:0.75rem;background:rgba(0,0,0,0.3);border-radius:var(--radius-sm);border-left:3px solid var(--gold-dim)}
.ob-feat .ico{font-size:1.1rem;flex-shrink:0;margin-top:0.1rem}
.ob-feat .txt{font-size:0.82rem;line-height:1.4;color:var(--text-secondary)}
.ob-feat strong{color:var(--text-primary);display:block;margin-bottom:0.1rem;font-size:0.85rem}
.draft-layout{display:grid;grid-template-columns:1fr 260px;gap:1.5rem;margin-top:1.5rem;animation:fadeUp 0.4s ease-out}
.draft-main{min-width:0}
.draft-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;flex-wrap:wrap;gap:0.75rem}
.pack-pick-label{font-family:'Cinzel',serif;font-size:1.3rem;color:var(--gold)}
.pack-pick-label span{color:var(--text-dim);font-size:0.85rem;font-weight:400}
.clock{font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:600;color:var(--aether);min-width:56px;text-align:center;padding:0.3rem 0.75rem;border-radius:var(--radius-sm);background:var(--aether-dim);border:1px solid rgba(59,130,246,0.15)}
.clock.urgent{color:var(--danger);background:rgba(248,113,113,0.1);border-color:rgba(248,113,113,0.2);animation:pulse 1s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.tutor-panel{padding:1.25rem 1.5rem;margin-bottom:1.25rem;border-left:3px solid var(--gold);background:linear-gradient(135deg,rgba(201,162,39,0.05),transparent)}
.tutor-head{display:flex;align-items:center;gap:0.6rem;margin-bottom:0.75rem;flex-wrap:wrap}
.tutor-icon{font-size:1.2rem}
.tutor-title{font-family:'Cinzel',serif;font-size:1rem;color:var(--gold)}
.tutor-depth{font-family:'JetBrains Mono',monospace;font-size:0.65rem;padding:0.15rem 0.5rem;border-radius:100px;background:var(--gold-dim);color:var(--gold);text-transform:uppercase;letter-spacing:0.1em}
.tutor-src{font-family:'JetBrains Mono',monospace;font-size:0.6rem;padding:0.15rem 0.5rem;border-radius:100px;text-transform:uppercase;letter-spacing:0.08em;margin-left:auto}
.tutor-src.api{background:rgba(52,211,153,0.12);color:var(--success)}
.tutor-src.local{background:var(--arcane-dim);color:var(--arcane-bright)}
.tutor-pick{font-size:1.15rem;font-weight:700;color:var(--text-primary);margin-bottom:0.5rem}
.tutor-reasoning{font-size:0.88rem;color:var(--text-secondary);line-height:1.6}
.tutor-metrics{display:flex;gap:1.5rem;margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid rgba(201,162,39,0.08)}
.tutor-metric-label{font-family:'JetBrains Mono',monospace;font-size:0.65rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim)}
.tutor-metric-val{font-size:0.95rem;font-weight:600;color:var(--text-primary)}
.pack-label{font-size:0.8rem;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);margin-bottom:0.75rem}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:1rem;margin-bottom:1.5rem}
.mtg-card{border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s ease;position:relative;background:var(--obsidian);border:2px solid rgba(255,255,255,0.04);overflow:hidden}
.mtg-card:hover{transform:translateY(-8px) scale(1.03);border-color:var(--gold);box-shadow:0 16px 40px rgba(0,0,0,0.5),0 0 20px var(--gold-dim);z-index:10}
.mtg-card-img{width:100%;aspect-ratio:488/680;object-fit:cover;display:block;background:rgba(0,0,0,0.4)}
.mtg-card-noimg{width:100%;aspect-ratio:488/680;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1rem;text-align:center;background:linear-gradient(135deg,var(--slate),var(--obsidian))}
.mtg-card-noimg .card-n{font-weight:600;font-size:0.82rem;margin-bottom:0.25rem}
.mtg-card-noimg .card-t{font-size:0.7rem;color:var(--text-dim)}
.card-badge{position:absolute;bottom:0.5rem;left:0.5rem;background:rgba(0,0,0,0.88);backdrop-filter:blur(6px);padding:0.2rem 0.55rem;border-radius:var(--radius-sm);font-family:'JetBrains Mono',monospace;font-size:0.7rem;font-weight:600;border:1px solid rgba(201,162,39,0.3);color:var(--gold-bright);z-index:2}
.sidebar{position:sticky;top:1.5rem;max-height:calc(100vh - 3rem);overflow-y:auto;padding:1.5rem}
.sidebar::-webkit-scrollbar{width:4px}
.sidebar::-webkit-scrollbar-track{background:transparent}
.sidebar::-webkit-scrollbar-thumb{background:var(--storm);border-radius:4px}
.sb-title{font-family:'Cinzel',serif;font-size:0.95rem;color:var(--gold);text-align:center;margin-bottom:1.25rem}
.skill-row{margin-bottom:1rem}
.skill-top{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:0.35rem}
.skill-name{font-size:0.78rem;font-weight:600;color:var(--text-primary)}
.skill-pct{font-family:'JetBrains Mono',monospace;font-size:0.78rem;font-weight:600;color:var(--gold)}
.skill-track{width:100%;height:5px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden}
.skill-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--arcane-bright));border-radius:3px;transition:width 0.5s ease}
.skill-hint{font-size:0.68rem;color:var(--text-dim);margin-top:0.25rem;line-height:1.3}
.sb-grade-box{margin-top:1rem;text-align:center;padding:1rem;border-radius:var(--radius-md);border:1.5px solid var(--gold-dim);background:linear-gradient(135deg,var(--gold-dim),transparent)}
.sb-grade-label{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);margin-bottom:0.35rem}
.sb-grade{font-family:'Cinzel Decorative',serif;font-size:2.2rem;font-weight:700;color:var(--gold)}
.deck-summary{margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,0.05)}
.deck-summary .ds-label{font-size:0.7rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);margin-bottom:0.5rem}
.color-pills{display:flex;gap:0.3rem;flex-wrap:wrap;margin-bottom:0.5rem}
.color-pill{padding:0.15rem 0.5rem;border-radius:100px;font-size:0.7rem;font-weight:600}
.color-pill.W{background:rgba(249,250,244,0.15);color:#f9faf4}.color-pill.U{background:rgba(14,104,171,0.25);color:#60a5fa}.color-pill.B{background:rgba(100,80,60,0.25);color:#a8a29e}.color-pill.R{background:rgba(211,32,42,0.2);color:#f87171}.color-pill.G{background:rgba(0,115,62,0.2);color:#34d399}.color-pill.C{background:rgba(150,150,150,0.15);color:#9ca3af}
.curve-row{display:flex;align-items:flex-end;gap:3px;height:40px}
.curve-bar{flex:1;background:linear-gradient(to top,var(--arcane),var(--aether));border-radius:2px 2px 0 0;min-height:2px;transition:height 0.3s;position:relative}
.curve-bar-label{position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);font-size:0.55rem;color:var(--text-dim)}
.feedback-overlay{position:fixed;inset:0;z-index:999;background:rgba(6,6,12,0.7);backdrop-filter:blur(6px);animation:fadeIn 0.2s}
.feedback-panel{position:fixed;bottom:0;left:0;right:0;z-index:1000;max-height:70vh;overflow-y:auto;padding:2rem;border-top:2px solid var(--gold);background:linear-gradient(to top,rgba(6,6,12,0.98),rgba(18,18,31,0.95));backdrop-filter:blur(20px);animation:slideUp 0.35s ease-out}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.fb-inner{max-width:1000px;margin:0 auto}
.fb-class-badge{display:inline-block;padding:0.6rem 2rem;border-radius:100px;font-family:'Cinzel',serif;font-size:1.1rem;font-weight:700;letter-spacing:0.05em;margin-bottom:0.5rem}
.fb-class-badge.premium{background:var(--gold-dim);border:2px solid var(--gold);color:var(--gold-bright)}
.fb-class-badge.strong{background:rgba(52,211,153,0.12);border:2px solid var(--success);color:var(--success)}
.fb-class-badge.solid{background:rgba(96,165,250,0.12);border:2px solid var(--info);color:var(--info)}
.fb-class-badge.loose{background:rgba(251,191,36,0.12);border:2px solid var(--warning);color:var(--warning)}
.fb-class-badge.shaky{background:rgba(251,146,60,0.12);border:2px solid #fb923c;color:#fb923c}
.fb-class-badge.punt{background:rgba(248,113,113,0.12);border:2px solid var(--danger);color:var(--danger)}
.fb-class-badge.trainwreck{background:rgba(220,38,38,0.12);border:2px solid #dc2626;color:#f87171}
.fb-class-badge.genius{background:linear-gradient(135deg,rgba(167,139,250,0.15),rgba(139,92,246,0.1));border:2px solid #a78bfa;color:#c4b5fd;animation:glowPulse 2s ease-in-out infinite}
@keyframes glowPulse{0%,100%{box-shadow:0 0 15px rgba(167,139,250,0.3)}50%{box-shadow:0 0 25px rgba(167,139,250,0.5)}}
.fb-ewr{font-size:0.8rem;color:var(--text-dim);margin-bottom:1.5rem}
.fb-compare{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem}
.fb-pick-card{text-align:center;padding:1.25rem;border-radius:var(--radius-md);background:rgba(0,0,0,0.3)}
.fb-pick-card.yours{border:2px solid var(--aether)}.fb-pick-card.engine{border:2px solid var(--gold)}.fb-pick-card.match{border:2px solid var(--success)}
.fb-pick-label{font-size:0.7rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);margin-bottom:0.5rem}
.fb-pick-name{font-size:1.1rem;font-weight:700;color:var(--text-primary);margin-bottom:0.25rem}
.fb-pick-rating{font-size:0.9rem;color:var(--gold);font-weight:600}
.fb-narrative{padding:1rem 1.25rem;border-left:3px solid var(--aether);background:rgba(59,130,246,0.05);border-radius:0 var(--radius-sm) var(--radius-sm) 0;margin-bottom:1rem}
.fb-narrative-label{font-size:0.7rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--aether);margin-bottom:0.4rem;font-weight:600}
.fb-narrative-text{font-size:0.9rem;color:var(--text-secondary);line-height:1.65}
.fb-misconception{padding:1rem 1.25rem;border-left:3px solid var(--danger);background:rgba(248,113,113,0.05);border-radius:0 var(--radius-sm) var(--radius-sm) 0;margin-bottom:1rem}
.fb-rubric{display:grid;grid-template-columns:repeat(5,1fr);gap:0.6rem;margin-bottom:1.5rem}
.fb-rubric-item{text-align:center;padding:0.75rem 0.5rem;background:rgba(0,0,0,0.25);border-radius:var(--radius-sm);border-top:3px solid var(--gold-dim)}
.fb-rubric-label{font-size:0.65rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.3rem}
.fb-rubric-val{font-size:1.4rem;font-weight:700;color:var(--gold)}
.fb-continue{width:100%;padding:1rem;background:linear-gradient(135deg,var(--gold),var(--arcane));color:white;border:none;border-radius:var(--radius-md);font-family:'Cinzel',serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 16px rgba(201,162,39,0.25)}
.fb-continue:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(201,162,39,0.35)}
.analysis-layout{max-width:900px;margin:2rem auto 0;animation:fadeUp 0.5s ease-out}
.grade-hero{text-align:center;padding:3rem 2rem;border-radius:var(--radius-xl);background:linear-gradient(135deg,rgba(201,162,39,0.08),rgba(124,92,191,0.08));border:2px solid var(--gold-dim);margin-bottom:2rem}
.grade-big{font-family:'Cinzel Decorative',serif;font-size:5rem;font-weight:700;color:var(--gold);line-height:1;margin-bottom:0.5rem;filter:drop-shadow(0 4px 20px var(--gold-glow))}
.grade-sub{font-size:1.1rem;color:var(--text-secondary)}
.analysis-rubric{display:grid;grid-template-columns:repeat(5,1fr);gap:0.75rem;margin-bottom:2rem}
.ar-item{text-align:center;padding:1.25rem 0.75rem;border-radius:var(--radius-md);background:rgba(0,0,0,0.3);border-top:3px solid var(--gold-dim)}
.ar-label{font-size:0.72rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.4rem}
.ar-val{font-size:1.8rem;font-weight:700;color:var(--gold);margin-bottom:0.25rem}
.ar-tip{font-size:0.68rem;color:var(--text-dim);line-height:1.3}
.loader-overlay{position:fixed;inset:0;z-index:2000;background:rgba(6,6,12,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.25rem}
.loader-ring{width:48px;height:48px;border:3px solid rgba(201,162,39,0.15);border-top-color:var(--gold);border-radius:50%;animation:spin 0.9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-text{font-size:0.9rem;color:var(--text-secondary);animation:fadeIn 0.3s}
.ai-log{padding:1rem 1.25rem;margin-bottom:1.25rem;max-height:220px;overflow-y:auto}
.ai-log::-webkit-scrollbar{width:4px}.ai-log::-webkit-scrollbar-thumb{background:var(--storm);border-radius:4px}
.ai-log-title{font-size:0.8rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);margin-bottom:0.75rem}
.ai-log-entry{padding:0.6rem 0.75rem;margin-bottom:0.4rem;background:rgba(0,0,0,0.25);border-radius:var(--radius-sm);border-left:2px solid var(--aether)}
.ai-log-head{display:flex;justify-content:space-between;font-size:0.72rem;font-weight:600}
.ai-log-player{color:var(--gold)}.ai-log-pp{color:var(--text-dim)}
.ai-log-card{font-size:0.8rem;font-weight:600;margin:0.15rem 0}.ai-log-text{font-size:0.72rem;color:var(--text-dim);line-height:1.4}
.conn-status{margin-top:0.75rem;padding:0.6rem 0.85rem;border-radius:var(--radius-sm);font-size:0.78rem;display:flex;align-items:center;gap:0.5rem}
.conn-status.ok{background:rgba(52,211,153,0.08);border:1px solid rgba(52,211,153,0.15);color:var(--success)}
.conn-status.fail{background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.15);color:var(--danger)}
.conn-status.testing{background:var(--arcane-dim);border:1px solid rgba(124,92,191,0.15);color:var(--arcane-bright)}
@media(max-width:1100px){.draft-layout{grid-template-columns:1fr}.sidebar{position:relative;top:0;max-height:none}}
@media(max-width:768px){.app-shell{padding:1rem}.diff-grid{grid-template-columns:repeat(2,1fr)}.fb-compare{grid-template-columns:1fr}.fb-rubric,.analysis-rubric{grid-template-columns:repeat(3,1fr)}.card-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:0.6rem}.onboard-features{grid-template-columns:1fr}.setup-section{padding:1.5rem}}
@media(max-width:480px){.diff-grid{grid-template-columns:1fr 1fr}.fb-rubric,.analysis-rubric{grid-template-columns:repeat(2,1fr)}}
    </style>
</head>
<body>
    <div class="bg-system"></div>
    <div class="bg-grid"></div>
    <div id="root"></div>

    <script type="text/babel">
const{useState,useEffect,useMemo}=React;
const SCRYFALL_API='https://api.scryfall.com';
const SET_DATA={'foundations':{code:'fdn',name:'Foundations'},'duskmourn':{code:'dsk',name:'Duskmourn'},'bloomburrow':{code:'blb',name:'Bloomburrow'},'modern-horizons-3':{code:'mh3',name:'Modern Horizons 3'},'outlaws':{code:'otj',name:'Outlaws of Thunder Junction'}};
const LEARNING_OUTCOMES={signal:{name:'Signal Reading',tip:'Strong cards passing late signal open colors'},timing:{name:'Color Timing',tip:'Stay open early, commit by picks 6-8'},curve:{name:'Curve Balance',tip:'Aim for 5-7 two/three-drops, limit top end'},synergy:{name:'Synergy Building',tip:'Prioritize cards fitting your emerging themes'},quality:{name:'Card Evaluation',tip:'Balance removal, bombs, and role players'}};
const RATING_VALUES={'A+':100,'A':95,'A-':88,'B+':80,'B':72,'B-':64,'C+':55,'C':45,'C-':35,'D':25};
const DIFF_META={common:{icon:'‚¨ú',cls:'common',desc:'Learn fundamentals'},uncommon:{icon:'‚¨õ',cls:'uncommon',desc:'Reinforce core concepts'},rare:{icon:'üü®',cls:'rare',desc:'Advanced signal reading'},mythic:{icon:'üî•',cls:'mythic',desc:'Expert optimization'}};

const safeColors=c=>Array.isArray(c)?c:[];
const safeString=s=>typeof s==='string'?s:'';
const safeNum=(n,f=0)=>typeof n==='number'&&!isNaN(n)?n:f;

function rateCard(card,deck=[]){
    if(!card)return{letter:'C',score:45};
    let base=50;const rarity=safeString(card.rarity);
    if(rarity==='mythic')base=93;else if(rarity==='rare')base=83;else if(rarity==='uncommon')base=68;else base=52;
    const typeLine=safeString(card.type),oracle=safeString(card.oracle_text),cmc=safeNum(card.cmc),colors=safeColors(card.colors);
    const power=parseInt(card.power)||0,toughness=parseInt(card.toughness)||0;
    if(typeLine.includes('Creature'))base+=Math.min(((power+toughness)/Math.max(cmc,1))*8,20);
    if(oracle.match(/destroy|exile|deals \d+ damage/i))base+=15;
    if(oracle.match(/draw|scry|surveil/i))base+=8;
    if(oracle.match(/flying|trample|lifelink|deathtouch/i))base+=6;
    if(deck.length>0){const dc=deck.flatMap(c=>safeColors(c.colors));if(dc.length>0){const m=colors.filter(col=>dc.includes(col)).length;base+=m>0?(m/Math.max(colors.length,1))*12:-8;}}
    const score=Math.min(100,Math.max(20,Math.round(base)));
    let letter;if(score>=95)letter='A+';else if(score>=88)letter='A';else if(score>=82)letter='A-';else if(score>=75)letter='B+';else if(score>=67)letter='B';else if(score>=60)letter='B-';else if(score>=50)letter='C+';else if(score>=40)letter='C';else letter='C-';
    return{letter,score};
}

async function fetchSetCards(setCode){
    let allCards=[],url=`${SCRYFALL_API}/cards/search?q=set:${setCode}+is:booster&unique=prints&order=set`;
    while(url){const r=await fetch(url);if(!r.ok){if(url.includes('is:booster')){url=`${SCRYFALL_API}/cards/search?q=set:${setCode}&unique=prints&order=set`;continue;}throw new Error(`Scryfall ${r.status}`);}
    const d=await r.json();if(!d.data||!Array.isArray(d.data))break;
    allCards=allCards.concat(d.data.map(card=>({id:card.id,name:card.name||'Unknown',type:card.type_line||'',cmc:safeNum(card.cmc),colors:safeColors(card.colors),color_identity:safeColors(card.color_identity),rarity:card.rarity||'common',image:card.image_uris?.normal||card.card_faces?.[0]?.image_uris?.normal||'',oracle_text:card.oracle_text||card.card_faces?.[0]?.oracle_text||'',power:card.power,toughness:card.toughness})));
    url=d.has_more?d.next_page:null;if(url)await new Promise(r=>setTimeout(r,100));}
    if(allCards.length===0)throw new Error('No cards found');return allCards;
}

function generatePack(cards,difficulty){
    const commons=cards.filter(c=>c.rarity==='common'),uncommons=cards.filter(c=>c.rarity==='uncommon'),rares=cards.filter(c=>c.rarity==='rare'||c.rarity==='mythic');
    const pack=[],usedIds=new Set();
    const addR=(pool,count)=>{const s=[...pool].sort(()=>Math.random()-0.5);let a=0;for(const c of s){if(a>=count)break;if(!usedIds.has(c.id)){usedIds.add(c.id);pack.push({...c});a++;}}};
    if(rares.length>0)addR(rares,1);addR(uncommons,3);addR(commons,15-pack.length);if(pack.length<15)addR(cards,15-pack.length);
    return pack.map(card=>{const{letter}=rateCard(card);return{...card,rating:letter};});
}

const lowCurve=p=>p.filter(c=>safeNum(c.cmc)<=2).length;
const midCurve=p=>p.filter(c=>{const v=safeNum(c.cmc);return v===3||v===4;}).length;
const highCurve=p=>p.filter(c=>safeNum(c.cmc)>=5).length;
const calcCurveScore=p=>{if(p.length<3)return 75;const t=p.length;return Math.max(20,Math.min(100,Math.round(100-Math.abs(lowCurve(p)/t-0.35)*80-Math.abs(midCurve(p)/t-0.40)*80-Math.abs(highCurve(p)/t-0.20)*80)));};
const calcTimingScore=(pn,p)=>{const c=p.filter(x=>safeColors(x.colors).length>0).length>=3;if(pn<=4&&c)return 55;if(pn>=9&&!c)return 55;if(pn>=6&&pn<=8&&c)return 95;return 78;};
const calcSignalScore=ps=>ps>=10?85:ps>=7?75:65;
const calcSynergyScore=(p,nc)=>{if(p.length===0)return 75;const nc2=safeColors(nc.colors);if(nc2.length===0)return 80;const dc=p.flatMap(x=>safeColors(x.colors));if(dc.length===0)return 75;const m=nc2.filter(c=>dc.includes(c)).length;const cs=(m/Math.max(nc2.length,1))*100;const dt=p.map(x=>safeString(x.type).split('‚Äî')[0].trim());const nt=safeString(nc.type).split('‚Äî')[0].trim();return Math.max(20,Math.min(100,Math.round(cs+(dt.filter(t=>t===nt).length/p.length>0.6?-15:0))));};

function simpleAIPick(pack,picks){
    if(!pack||pack.length===0)return null;
    const scored=pack.map(card=>{const{letter,score}=rateCard(card,picks);return{card:{...card},score,letter};}).sort((a,b)=>b.score-a.score);
    const best=scored[0];return{card:best.card,cardScore:best.score,reasoning:genLocalReasoning(best.card,picks),cost:0,source:'local'};
}

function genLocalReasoning(card,deck){
    const colors=safeColors(card.colors),typeLine=safeString(card.type),cmc=safeNum(card.cmc),parts=[];
    if(deck.length===0){parts.push(`${card.name} is a strong first pick.`);parts.push(typeLine.includes('Creature')?'Establishes early board presence.':'Provides flexibility to build around.');}
    else{const dc=[...new Set(deck.flatMap(c=>safeColors(c.colors)))];const m=colors.filter(c=>dc.includes(c));
    if(m.length>0)parts.push(`${card.name} fits your ${dc.join('/')} build.`);else if(colors.length===0)parts.push(`${card.name} is colorless ‚Äî slots into any deck.`);else parts.push(`${card.name} is off-color ‚Äî only splash if power justifies it.`);
    if(cmc<=2&&lowCurve(deck)<4)parts.push('Your curve needs more early plays.');else if(cmc>=5&&highCurve(deck)>=4)parts.push('Watch your top end.');}
    return parts.join(' ');
}

function genNarrative(same,ewrLoss,card,engCard,deck){
    if(same){const dc=[...new Set(deck.flatMap(c=>safeColors(c.colors)))].filter(c=>c);
    if(deck.length<=3)return`Excellent pick. ${card.name} is the clear best card in this pack ‚Äî strong evaluation from the start.`;
    if(dc.length>0)return`Perfect read. ${card.name} matches the tutor recommendation, strengthening your ${dc.join('/')} build.`;
    return`Optimal selection. ${card.name} is the best card here, and you identified it correctly.`;}
    if(ewrLoss<=5)return`Near-optimal. ${card.name} is very close in value to ${engCard.name} ‚Äî the gap is marginal.`;
    if(ewrLoss<=12)return`Solid selection. ${card.name} is reasonable, though ${engCard.name} edges it out in this context.`;
    if(ewrLoss<=20)return`Decent pick, but ${engCard.name} better serves your deck. Consider curve and color commitment over isolated evaluation.`;
    if(ewrLoss<=35)return`${card.name} is playable but a meaningful downgrade from ${engCard.name}. Are you chasing power when synergy matters more?`;
    return`This pick needs review. ${engCard.name} was significantly stronger in context. Focus on what your deck needs.`;
}

function genMisconception(same,ewrLoss,card,engCard){
    if(same||ewrLoss<=12)return null;
    const cc=safeColors(card.colors),ec=safeColors(engCard.colors);
    if(cc.length>0&&ec.length>0&&!cc.some(c=>ec.includes(c)))return'Possible off-color bias: check which colors are flowing from your right.';
    if(safeNum(card.cmc)>safeNum(engCard.cmc)+2)return'Top-heavy tendency: too many expensive spells leads to clunky draws.';
    if(ewrLoss>30)return'Card evaluation gap: a B+ in your colors often outperforms an A off-color in Limited.';
    return'Consider the full picture: removal, curve, and color consistency often outweigh individual card quality.';
}

function DraftTutor(){
    const[screen,setScreen]=useState('setup');
    const[showOnboarding,setShowOnboarding]=useState(true);
    const[loading,setLoading]=useState(false);
    const[loadMsg,setLoadMsg]=useState('');
    const[setKey,setSetKey]=useState('foundations');
    const[difficulty,setDifficulty]=useState('rare');
    const[useProxy,setUseProxy]=useState(false);
    const[proxyUrl,setProxyUrl]=useState('');
    const[proxyStatus,setProxyStatus]=useState('idle');
    const[showAILog,setShowAILog]=useState(false);
    const[allCards,setAllCards]=useState([]);
    const[packs,setPacks]=useState([]);
    const[players,setPlayers]=useState([]);
    const[packNum,setPackNum]=useState(1);
    const[pickNum,setPickNum]=useState(1);
    const[timer,setTimer]=useState(60);
    const[bestMove,setBestMove]=useState(null);
    const[aiLog,setAiLog]=useState([]);
    const[adaptiveDiff,setAdaptiveDiff]=useState('rare');
    const[skills,setSkills]=useState(()=>Object.keys(LEARNING_OUTCOMES).reduce((a,k)=>({...a,[k]:{score:0,picks:0}}),{}));
    const[showFeedback,setShowFeedback]=useState(false);
    const[assessment,setAssessment]=useState(null);
    const[grade,setGrade]=useState('');
    const[analysis,setAnalysis]=useState(null);
    const[apiCalls,setApiCalls]=useState(0);
    const[totalCost,setTotalCost]=useState(0);

    useEffect(()=>{if(screen!=='draft'||timer<=0||showFeedback||loading)return;const id=setInterval(()=>setTimer(t=>t-1),1000);return()=>clearInterval(id);},[screen,timer,showFeedback,loading]);
    useEffect(()=>{if(timer===0&&screen==='draft'&&packs[0]?.length>0&&!showFeedback&&!loading)handlePick(packs[0][0]);},[timer]);

    const testProxy=async(url)=>{if(!url){setProxyStatus('idle');return;}setProxyStatus('testing');
    try{const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-5-20250929',max_tokens:20,messages:[{role:'user',content:'Reply with only: CONNECTED'}]})});
    if(!r.ok){console.error('[Proxy Test] HTTP',r.status);setProxyStatus('fail');return;}
    const d=await r.json();console.log('[Proxy Test]',d.content?.[0]?.text,'Usage:',d.usage);setProxyStatus('ok');}
    catch(e){console.error('[Proxy Test]',e);setProxyStatus('fail');}};

    const callClaude=async(prompt)=>{if(!useProxy||!proxyUrl)return null;
    try{console.log('[Claude API] Sending to:',proxyUrl);
    const r=await fetch(proxyUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-5-20250929',max_tokens:500,messages:[{role:'user',content:prompt}]})});
    if(!r.ok){console.error('[Claude API] HTTP',r.status,await r.text().catch(()=>''));return null;}
    const d=await r.json();console.log('[Claude API] OK. Tokens:',d.usage);
    if(d.fallback)return null;
    const inT=d.usage?.input_tokens||0,outT=d.usage?.output_tokens||0;
    setTotalCost(p=>p+(inT*0.000003)+(outT*0.000015));setApiCalls(p=>p+1);
    return d.content?.[0]?.text||null;}catch(e){console.error('[Claude API]',e);return null;}};

    const getAIPick=async(pack,picks)=>{
    if(!pack||pack.length===0)return simpleAIPick(pack||[],picks);
    if(useProxy&&proxyUrl){
    const prompt=`You are an expert MTG Limited draft tutor for ${SET_DATA[setKey]?.name||'Unknown'} at ${adaptiveDiff.toUpperCase()} difficulty.\n\nPack ${packNum}, Pick ${pickNum}\nStudent deck (${picks.length}): ${picks.map(c=>c.name).join(', ')||'Empty'}\n\nPack:\n${pack.map(c=>`- ${c.name} [${safeString(c.type)}] ${safeColors(c.colors).join('/')||'Colorless'} CMC:${safeNum(c.cmc)}`).join('\n')}\n\nSelect the best card. Use this exact format:\nPICK: [exact card name]\nREASONING: [2-3 sentences on why, considering deck context, curve, signals, synergy]`;
    const text=await callClaude(prompt);
    if(text){console.log('[Claude API] Raw:',text);
    const pm=text.match(/PICK:\s*(.+)/i),rm=text.match(/REASONING:\s*(.+)/is);
    const cn=pm?.[1]?.trim(),matched=pack.find(c=>c.name.toLowerCase()===cn?.toLowerCase());
    if(matched){const{score}=rateCard(matched,picks);return{card:matched,cardScore:score,reasoning:rm?.[1]?.trim()||genLocalReasoning(matched,picks),cost:0,source:'claude'};}
    else console.warn('[Claude API] Card not in pack:',cn);}}
    return simpleAIPick(pack,picks);};

    const startDraft=async()=>{setLoading(true);setLoadMsg('Connecting to Scryfall...');setShowOnboarding(false);
    try{const code=SET_DATA[setKey]?.code||'fdn';const cards=await fetchSetCards(code);setAllCards(cards);
    setLoadMsg('Generating packs...');const np=[];for(let i=0;i<8;i++)np.push(generatePack(cards,adaptiveDiff));
    const npl=Array.from({length:8},(_,i)=>({id:i,name:i===0?'You':`Drafter ${i}`,picks:[]}));
    setPacks(np);setPlayers(npl);setPackNum(1);setPickNum(1);setTimer(60);setAiLog([]);setBestMove(null);setApiCalls(0);setTotalCost(0);
    setSkills(Object.keys(LEARNING_OUTCOMES).reduce((a,k)=>({...a,[k]:{score:0,picks:0}}),{}));
    setLoadMsg('Tutor analyzing...');const tp=await getAIPick(np[0],[]);
    setBestMove({card:tp.card,cardScore:tp.cardScore,reasoning:tp.reasoning,evaluation:70,source:tp.source});
    setScreen('draft');}catch(e){console.error('Init error:',e);alert(`Failed: ${e.message}`);}finally{setLoading(false);setLoadMsg('');}};

    const handlePick=async(card)=>{if(!card||showFeedback||loading)return;
    const np=players.map((p,i)=>i===0?{...p,picks:[...p.picks,{...card,packNum,pickNum}]}:{...p});
    const isSameCard=bestMove?(card.id===bestMove.card.id):true;
    const{score:yourScore}=rateCard(card,np[0].picks);
    const engineScore=bestMove?bestMove.cardScore:yourScore;
    const ewrLoss=isSameCard?0:Math.max(0,Math.round(engineScore-yourScore));
    const qualityScore=yourScore,curveScore=calcCurveScore(np[0].picks),timingScore=calcTimingScore(pickNum,np[0].picks),signalScore=calcSignalScore(packs[0]?.length||0),synergyScore=calcSynergyScore(np[0].picks.slice(0,-1),card);
    let classification,classColor;
    if(isSameCard||ewrLoss<=3){classification='Premium Pick';classColor='premium';}
    else if(ewrLoss<=8){classification='Strong Pick';classColor='strong';}
    else if(ewrLoss<=15){classification='Solid Pick';classColor='solid';}
    else if(ewrLoss<=22){classification='Loose Pick';classColor='loose';}
    else if(ewrLoss<=32){classification='Shaky Pick';classColor='shaky';}
    else if(ewrLoss<=45){classification='Punt';classColor='punt';}
    else{classification='Trainwreck';classColor='trainwreck';}
    if(isSameCard&&(packs[0]?.length||0)>=8){classification='Genius Read';classColor='genius';}
    const narrative=genNarrative(isSameCard,ewrLoss,card,bestMove?.card||card,np[0].picks);
    const misconception=genMisconception(isSameCard,ewrLoss,card,bestMove?.card||card);
    const displayEngineRating=isSameCard?card.rating:(bestMove?.card?.rating||card.rating);
    const ns={...skills};const sm={signal:signalScore,timing:timingScore,curve:curveScore,synergy:synergyScore,quality:qualityScore};
    Object.entries(sm).forEach(([k,v])=>{ns[k]={score:ns[k].score+v,picks:ns[k].picks+1};});setSkills(ns);
    const avg=Object.values(ns).reduce((s,sk)=>s+(sk.picks>0?sk.score/sk.picks:0),0)/5;
    if(avg>85&&adaptiveDiff!=='mythic')setAdaptiveDiff('mythic');else if(avg<55&&adaptiveDiff!=='common')setAdaptiveDiff('common');
    setAssessment({isSameCard,yourPick:card,enginePick:bestMove?.card||card,displayEngineRating,classification,classColor,ewrLoss,narrative,misconception,rubric:{quality:Math.round(qualityScore),curve:Math.round(curveScore),timing:Math.round(timingScore),signal:Math.round(signalScore),synergy:Math.round(synergyScore)}});
    setPlayers(np);setShowFeedback(true);};

    const continueAfterAssessment=async()=>{setShowFeedback(false);setLoading(true);setLoadMsg('Opponents drafting...');
    const np=[...players],nk=[...packs];
    for(let i=1;i<8;i++){if(nk[i]?.length>0){const ai=simpleAIPick(nk[i],np[i].picks);if(ai?.card){np[i]={...np[i],picks:[...np[i].picks,{...ai.card,packNum,pickNum}]};nk[i]=nk[i].filter(c=>c.id!==ai.card.id);
    if(showAILog)setAiLog(prev=>[{player:np[i].name,card:ai.card.name,reasoning:ai.reasoning,pp:`P${packNum}P${pickNum}`},...prev].slice(0,15));}}}
    if(assessment?.yourPick)nk[0]=(nk[0]||[]).filter(c=>c.id!==assessment.yourPick.id);
    const pp=[...nk];if(packNum%2===1){const l=pp.pop();pp.unshift(l);}else{const f=pp.shift();pp.push(f);}
    setPlayers(np);const nx=pickNum+1;
    if(nx>15||(pp[0]?.length||0)===0){if(packNum>=3){await finalizeDraft(np[0].picks);setLoading(false);return;}
    setLoadMsg('Next pack...');const fp=[];for(let i=0;i<8;i++)fp.push(generatePack(allCards,adaptiveDiff));setPacks(fp);setPackNum(p=>p+1);setPickNum(1);
    setLoadMsg('Tutor analyzing...');const tp=await getAIPick(fp[0],np[0].picks);setBestMove({card:tp.card,cardScore:tp.cardScore,reasoning:tp.reasoning,evaluation:Math.min(95,60+np[0].picks.length*1.5),source:tp.source});}
    else{setPacks(pp);setPickNum(nx);setLoadMsg('Tutor analyzing...');const tp=await getAIPick(pp[0]||[],np[0].picks);setBestMove({card:tp.card,cardScore:tp.cardScore,reasoning:tp.reasoning,evaluation:Math.min(95,60+np[0].picks.length*1.5),source:tp.source});}
    setTimer(60);setLoading(false);setLoadMsg('');};

    const finalizeDraft=async(picks)=>{setLoadMsg('Compiling analytics...');
    const curve={0:0,1:0,2:0,3:0,4:0,5:0,'6+':0};picks.forEach(c=>{const v=safeNum(c.cmc);curve[v>=6?'6+':v]++;});
    const colors={W:0,U:0,B:0,R:0,G:0};picks.forEach(c=>safeColors(c.colors).forEach(col=>{if(colors[col]!==undefined)colors[col]++;}));
    const sorted=Object.entries(colors).sort((a,b)=>b[1]-a[1]);const primary=sorted.filter(([,v])=>v>0).slice(0,2).map(([c])=>c);
    const avgR=picks.reduce((s,c)=>s+(RATING_VALUES[c.rating]||rateCard(c).score),0)/Math.max(picks.length,1);
    const cS=calcCurveScore(picks),colS=sorted[0]?.[1]>=10&&(sorted[1]?.[1]||0)>=5?85:65;
    const overall=avgR*0.4+cS*0.3+colS*0.3;let g;
    if(overall>=90)g='A+';else if(overall>=85)g='A';else if(overall>=80)g='A-';else if(overall>=75)g='B+';else if(overall>=68)g='B';else if(overall>=62)g='B-';else g='C+';
    const sa=Object.fromEntries(Object.entries(skills).map(([k,s])=>[k,s.picks>0?Math.round(s.score/s.picks):0]));
    setGrade(g);setAnalysis({curve,colors,primaryColors:primary,skillAverages:sa});setScreen('analysis');};

    const resetDraft=()=>{setScreen('setup');setPacks([]);setPlayers([]);setBestMove(null);setAiLog([]);setGrade('');setAnalysis(null);setAdaptiveDiff(difficulty);};

    const sessionGrade=useMemo(()=>{const a=Object.values(skills).reduce((s,sk)=>s+(sk.picks>0?sk.score/sk.picks:0),0)/5;if(a>=90)return'A+';if(a>=85)return'A';if(a>=80)return'A-';if(a>=75)return'B+';if(a>=70)return'B';if(a>=65)return'B-';return'C+';},[skills]);
    const deckColors=useMemo(()=>{if(!players[0])return{};const c={};players[0].picks.forEach(x=>{const cl=safeColors(x.colors);if(cl.length===0)c['C']=(c['C']||0)+1;else cl.forEach(col=>{c[col]=(c[col]||0)+1;});});return c;},[players]);
    const deckCurve=useMemo(()=>{if(!players[0])return{};const c={};players[0].picks.forEach(x=>{const k=safeNum(x.cmc)>=6?'6+':String(Math.min(safeNum(x.cmc),7));c[k]=(c[k]||0)+1;});return c;},[players]);
    const proxyConnected=proxyStatus==='ok'&&useProxy&&proxyUrl;

    return(
    <div className="app-shell">
    {loading&&<div className="loader-overlay"><div className="loader-ring"/><div className="loader-text">{loadMsg||'Loading...'}</div></div>}
    <header className="masthead"><div className="logo">MTG Draft Tutor</div><div className="tagline">Engineered for Mastery</div>
    <div className={`mode-badge ${proxyConnected?'live':proxyStatus==='fail'?'error':'local'}`}><span className="dot"/>
    {proxyConnected?`Claude AI Connected ¬∑ ${apiCalls} calls`:proxyStatus==='fail'?'Proxy Error ‚Äî Local Tutor':'Local Tutor Active'}</div></header>

    {showOnboarding&&screen==='setup'&&(
    <div className="onboard-overlay" onClick={()=>setShowOnboarding(false)}>
    <div className="glass-accent onboard-card" onClick={e=>e.stopPropagation()}>
    <div className="onboard-title">Welcome, Planeswalker</div>
    <div className="onboard-body">This simulator teaches MTG Limited drafting through guided practice. Every pick is assessed across five skill dimensions.</div>
    <div className="onboard-features">
    <div className="ob-feat"><span className="ico">üìä</span><div className="txt"><strong>5 Skill Dimensions</strong>Signals, timing, curve, synergy, evaluation</div></div>
    <div className="ob-feat"><span className="ico">‚ö°</span><div className="txt"><strong>Tutor Engine</strong>Real-time recommendations with reasoning</div></div>
    <div className="ob-feat"><span className="ico">üîÑ</span><div className="txt"><strong>Adaptive Difficulty</strong>Scales to your demonstrated skill level</div></div>
    <div className="ob-feat"><span className="ico">üß†</span><div className="txt"><strong>Instant Feedback</strong>Every pick assessed with formative analysis</div></div>
    </div>
    <button className="btn-primary" onClick={()=>setShowOnboarding(false)}>Configure Session ‚Üí</button>
    </div></div>)}

    {screen==='setup'&&!showOnboarding&&(
    <div className="setup-layout">
    <div className="glass-accent setup-section">
    <div className="section-label"><span className="icon">‚öô</span> Session Configuration</div>
    <div className="field"><label className="field-label">Draft Set</label>
    <select className="select" value={setKey} onChange={e=>setSetKey(e.target.value)}>
    {Object.entries(SET_DATA).map(([k,v])=><option key={k} value={k}>{v.name}</option>)}</select></div>
    <div className="field"><label className="field-label">Starting Difficulty</label>
    <div className="diff-grid">{Object.entries(DIFF_META).map(([k,v])=>(
    <div key={k} className={`diff-card ${v.cls} ${difficulty===k?'active':''}`} onClick={()=>{setDifficulty(k);setAdaptiveDiff(k);}}>
    <div className="diff-icon">{v.icon}</div><div className="diff-name">{k.charAt(0).toUpperCase()+k.slice(1)}</div>
    <div className="diff-desc">{v.desc}</div></div>))}</div>
    <div className="field-hint">Adapts automatically based on performance</div></div></div>

    <div className="glass-accent setup-section">
    <div className="section-label"><span className="icon">ü§ñ</span> Tutor Options</div>
    <label className="toggle-row" htmlFor="proxy-toggle">
    <div className="toggle-switch"><input type="checkbox" id="proxy-toggle" checked={useProxy} onChange={e=>setUseProxy(e.target.checked)}/><span className="toggle-track"/></div>
    <div><div className="toggle-text">Enable Claude AI Tutor</div>
    <div className="toggle-sub">Requires a proxy endpoint ‚Äî falls back to local engine if disabled</div></div></label>

    {useProxy&&(<div className="field" style={{marginTop:'0.75rem'}}>
    <label className="field-label">Claude Proxy Endpoint</label>
    <input className="input" type="url" value={proxyUrl} onChange={e=>{setProxyUrl(e.target.value);setProxyStatus('idle');}} placeholder="https://your-worker.workers.dev/"/>
    <div className="field-hint">Cloudflare Worker URL proxying to Claude API.
    {proxyUrl&&proxyStatus==='idle'&&(<span>{' '}<a href="#" style={{color:'var(--arcane-bright)'}} onClick={e=>{e.preventDefault();testProxy(proxyUrl);}}>Test Connection</a></span>)}</div>
    {proxyStatus==='testing'&&<div className="conn-status testing">‚è≥ Testing connection...</div>}
    {proxyStatus==='ok'&&<div className="conn-status ok">‚úì Connected to Claude API successfully</div>}
    {proxyStatus==='fail'&&<div className="conn-status fail">‚úó Connection failed ‚Äî check URL and CORS (see console)</div>}
    </div>)}

    <label className="toggle-row" htmlFor="ailog-toggle" style={{marginTop:'0.5rem'}}>
    <div className="toggle-switch"><input type="checkbox" id="ailog-toggle" checked={showAILog} onChange={e=>setShowAILog(e.target.checked)}/><span className="toggle-track"/></div>
    <div><div className="toggle-text">Show Opponent Draft Log</div>
    <div className="toggle-sub">Observe AI strategies for vicarious learning</div></div></label></div>
    <button className="btn-primary" onClick={startDraft}>Launch Draft</button></div>)}

    {screen==='draft'&&packs.length>0&&(
    <div className="draft-layout"><div className="draft-main">
    <div className="draft-bar"><div className="pack-pick-label">Pack {packNum}, Pick {pickNum}<span> ‚Äî {packs[0]?.length||0} remaining</span></div>
    <div className={`clock ${timer<=10?'urgent':''}`}>{timer}s</div></div>

    {bestMove&&(<div className="glass tutor-panel"><div className="tutor-head">
    <span className="tutor-icon">‚ö°</span><span className="tutor-title">Tutor Recommendation</span>
    <span className="tutor-depth">{adaptiveDiff}</span>
    <span className={`tutor-src ${bestMove.source==='claude'?'api':'local'}`}>{bestMove.source==='claude'?'‚óè Claude':'‚óã Local'}</span></div>
    <div className="tutor-pick">{bestMove.card.name}</div>
    <div className="tutor-reasoning">{bestMove.reasoning}</div>
    <div className="tutor-metrics"><div><div className="tutor-metric-label">Position</div><div className="tutor-metric-val">{Math.round(bestMove.evaluation)}%</div></div>
    <div><div className="tutor-metric-label">Rating</div><div className="tutor-metric-val">{bestMove.card.rating}</div></div>
    <div><div className="tutor-metric-label">Colors</div><div className="tutor-metric-val">{safeColors(bestMove.card.colors).join('/')||'C'}</div></div></div></div>)}

    {showAILog&&aiLog.length>0&&(<div className="glass ai-log"><div className="ai-log-title">Opponent Draft Log</div>
    {aiLog.map((e,i)=>(<div key={i} className="ai-log-entry"><div className="ai-log-head"><span className="ai-log-player">{e.player}</span><span className="ai-log-pp">{e.pp}</span></div>
    <div className="ai-log-card">{e.card}</div><div className="ai-log-text">{e.reasoning}</div></div>))}</div>)}

    <div className="pack-label">Select your card</div>
    <div className="card-grid">{(packs[0]||[]).map(card=>(
    <div key={card.id} className="mtg-card" onClick={()=>handlePick(card)}>
    {card.image?<img src={card.image} alt={card.name} className="mtg-card-img" loading="lazy"/>:
    <div className="mtg-card-noimg"><div className="card-n">{card.name}</div><div className="card-t">{card.type}</div></div>}
    <div className="card-badge">{card.rating}</div></div>))}</div></div>

    <div className="glass sidebar"><div className="sb-title">Learning Progress</div>
    {Object.entries(LEARNING_OUTCOMES).map(([key,{name,tip}])=>{const avg=skills[key].picks>0?Math.round(skills[key].score/skills[key].picks):0;return(
    <div key={key} className="skill-row"><div className="skill-top"><span className="skill-name">{name}</span><span className="skill-pct">{avg}%</span></div>
    <div className="skill-track"><div className="skill-fill" style={{width:`${avg}%`}}/></div>
    <div className="skill-hint">{tip}</div></div>);})}
    <div className="sb-grade-box"><div className="sb-grade-label">Session Grade</div><div className="sb-grade">{sessionGrade}</div></div>
    {players[0]?.picks.length>0&&(<div className="deck-summary"><div className="ds-label">Deck ¬∑ {players[0].picks.length} cards</div>
    <div className="color-pills">{Object.entries(deckColors).sort((a,b)=>b[1]-a[1]).map(([c,n])=><span key={c} className={`color-pill ${c}`}>{c}: {n}</span>)}</div>
    <div className="ds-label" style={{marginTop:'0.5rem'}}>Mana Curve</div>
    <div className="curve-row" style={{marginBottom:'1rem'}}>{['0','1','2','3','4','5','6+'].map(k=>{const val=deckCurve[k]||0;const mx=Math.max(...Object.values(deckCurve),1);
    return<div key={k} className="curve-bar" style={{height:`${(val/mx)*100}%`}}><span className="curve-bar-label">{k}</span></div>;})}</div></div>)}</div></div>)}

    {showFeedback&&assessment&&(<>
    <div className="feedback-overlay"/>
    <div className="feedback-panel"><div className="fb-inner">
    <div style={{textAlign:'center',marginBottom:'1rem'}}>
    <div className={`fb-class-badge ${assessment.classColor}`}>{assessment.classification}</div>
    {assessment.ewrLoss>0&&<div className="fb-ewr">Opportunity Gap: {assessment.ewrLoss}%</div>}</div>

    {assessment.isSameCard?(
    <div className="fb-compare" style={{gridTemplateColumns:'1fr'}}>
    <div className="fb-pick-card match"><div className="fb-pick-label">Your Selection = Tutor Recommendation</div>
    <div className="fb-pick-name">{assessment.yourPick.name}</div><div className="fb-pick-rating">{assessment.yourPick.rating}</div></div></div>
    ):(
    <div className="fb-compare">
    <div className="fb-pick-card yours"><div className="fb-pick-label">Your Selection</div><div className="fb-pick-name">{assessment.yourPick.name}</div><div className="fb-pick-rating">{assessment.yourPick.rating}</div></div>
    <div className="fb-pick-card engine"><div className="fb-pick-label">Tutor Suggestion</div><div className="fb-pick-name">{assessment.enginePick.name}</div><div className="fb-pick-rating">{assessment.displayEngineRating}</div></div></div>)}

    <div className="fb-narrative"><div className="fb-narrative-label">Tutor Feedback</div><div className="fb-narrative-text">{assessment.narrative}</div></div>
    {assessment.misconception&&(<div className="fb-misconception"><div className="fb-narrative-label" style={{color:'var(--danger)'}}>Misconception Alert</div><div className="fb-narrative-text">{assessment.misconception}</div></div>)}
    <div className="fb-rubric">{Object.entries(assessment.rubric).map(([key,score])=>(<div key={key} className="fb-rubric-item"><div className="fb-rubric-label">{LEARNING_OUTCOMES[key]?.name||key}</div><div className="fb-rubric-val">{score}%</div></div>))}</div>
    <button className="fb-continue" onClick={continueAfterAssessment}>Continue ‚Üí</button>
    </div></div></>)}

    {screen==='analysis'&&analysis&&(
    <div className="analysis-layout">
    <div className="grade-hero"><div className="grade-big">{grade}</div><div className="grade-sub">Draft Complete ‚Äî {players[0]?.picks.length||0} Cards Drafted</div></div>
    <div className="glass-accent" style={{padding:'1.5rem',marginBottom:'1.5rem'}}>
    <div className="fb-narrative-label">Draft Summary</div>
    <div className="fb-narrative-text">Your deck features {analysis.primaryColors.join('/')} with {players[0]?.picks.length||0} cards.
    {' '}Strongest: {Object.entries(analysis.skillAverages).sort((a,b)=>b[1]-a[1])[0]?.[0]} at {Object.entries(analysis.skillAverages).sort((a,b)=>b[1]-a[1])[0]?.[1]}%.
    {' '}Growth area: {Object.entries(analysis.skillAverages).sort((a,b)=>a[1]-b[1])[0]?.[0]} ‚Äî {LEARNING_OUTCOMES[Object.entries(analysis.skillAverages).sort((a,b)=>a[1]-b[1])[0]?.[0]]?.tip||'keep practicing'}.</div></div>
    <div className="analysis-rubric">{Object.entries(analysis.skillAverages).map(([key,score])=>(<div key={key} className="ar-item"><div className="ar-label">{LEARNING_OUTCOMES[key]?.name||key}</div><div className="ar-val">{score}%</div><div className="ar-tip">{LEARNING_OUTCOMES[key]?.tip}</div></div>))}</div>
    {apiCalls>0&&<div style={{textAlign:'center',fontSize:'0.8rem',color:'var(--text-dim)',marginBottom:'1rem'}}>Session: {apiCalls} Claude API calls ¬∑ ${totalCost.toFixed(4)} estimated cost</div>}
    <button className="btn-primary" onClick={resetDraft} style={{marginBottom:'2rem'}}>Draft Again for Mastery</button></div>)}
    </div>);
}

ReactDOM.render(<DraftTutor/>,document.getElementById('root'));
    </script>
</body>
</html>
