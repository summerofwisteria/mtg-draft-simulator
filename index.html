html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Draft Tutor - Master Limited Drafting</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --deep-black: #0a0a0f;
            --rich-purple: #6b46c1;
            --royal-gold: #d4af37;
            --mystic-blue: #4a90e2;
            --soft-white: #f8f8ff;
            --border-color: rgba(212, 175, 55, 0.2);
            
            /* MTG Rarity Colors */
            --common-gray: #8a8a8a;
            --uncommon-silver: #c0c0c0;
            --rare-gold: #d4af37;
            --mythic-orange: #ff8c00;
            
            /* New: Feedback Colors */
            --success-green: #4ade80;
            --warning-yellow: #fbbf24;
            --error-red: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--deep-black);
            color: var(--soft-white);
            overflow-x: hidden;
        }

        #magicBg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: radial-gradient(ellipse at top, rgba(107, 70, 193, 0.15), transparent),
                        radial-gradient(ellipse at bottom, rgba(74, 144, 226, 0.1), transparent);
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.8), transparent);
            border-radius: 50%;
            animation: float linear infinite;
            opacity: 0.6;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            50% { opacity: 0.6; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        #app {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .title {
            font-family: 'Cinzel', serif;
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--royal-gold), var(--mystic-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--mystic-blue);
            font-weight: 300;
        }

        .api-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--rich-purple), var(--mystic-blue));
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 1rem;
        }

        /* Setup Screen */
        .setup-screen {
            max-width: 900px;
            margin: 0 auto;
        }

        .setup-card {
            background: rgba(26, 26, 36, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 3rem;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--royal-gold);
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: var(--mystic-blue);
            margin-bottom: 0.75rem;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--soft-white);
            font-size: 1rem;
            font-family: 'IBM Plex Sans', sans-serif;
            transition: all 0.3s ease;
        }

        .form-select {
            width: 100%;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--soft-white);
            font-size: 1rem;
            font-family: 'IBM Plex Sans', sans-serif;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--royal-gold);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        .form-help {
            font-size: 0.85rem;
            color: var(--soft-white);
            opacity: 0.6;
            margin-top: 0.5rem;
        }

        /* MTG Rarity Difficulty Selector */
        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .difficulty-option {
            background: rgba(0, 0, 0, 0.4);
            border: 3px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .difficulty-option:hover {
            transform: translateY(-5px);
        }

        .difficulty-option.selected {
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.4);
        }

        .difficulty-option.common {
            border-color: var(--common-gray);
        }

        .difficulty-option.common.selected {
            border-color: var(--common-gray);
            box-shadow: 0 10px 40px rgba(138, 138, 138, 0.5);
        }

        .difficulty-option.uncommon {
            border-color: var(--uncommon-silver);
        }

        .difficulty-option.uncommon.selected {
            border-color: var(--uncommon-silver);
            box-shadow: 0 10px 40px rgba(192, 192, 192, 0.5);
        }

        .difficulty-option.rare {
            border-color: var(--rare-gold);
        }

        .difficulty-option.rare.selected {
            border-color: var(--rare-gold);
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.6);
        }

        .difficulty-option.mythic {
            border-color: var(--mythic-orange);
            background: linear-gradient(135deg, rgba(255, 140, 0, 0.1), transparent);
        }

        .difficulty-option.mythic.selected {
            border-color: var(--mythic-orange);
            box-shadow: 0 10px 40px rgba(255, 140, 0, 0.7);
        }

        .difficulty-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
        }

        .difficulty-name {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .difficulty-option.common .difficulty-name {
            color: var(--common-gray);
        }

        .difficulty-option.uncommon .difficulty-name {
            color: var(--uncommon-silver);
        }

        .difficulty-option.rare .difficulty-name {
            color: var(--rare-gold);
        }

        .difficulty-option.mythic .difficulty-name {
            background: linear-gradient(135deg, #ff8c00, #ff4500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .difficulty-desc {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.4;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .button {
            background: linear-gradient(135deg, var(--rich-purple), var(--mystic-blue));
            color: var(--soft-white);
            border: none;
            padding: 1.25rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
            width: 100%;
            box-shadow: 0 10px 30px rgba(107, 70, 193, 0.4);
        }

        .button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(107, 70, 193, 0.6);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Chess Engine Style Analysis */
        .engine-panel {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.6), rgba(26, 26, 36, 0.8));
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px solid var(--royal-gold);
            position: relative;
        }

        .engine-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .engine-icon {
            font-size: 2rem;
        }

        .engine-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--royal-gold);
        }

        .engine-subtitle {
            font-size: 0.85rem;
            color: var(--mystic-blue);
            opacity: 0.8;
        }

        .best-move-display {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid var(--royal-gold);
        }

        .best-move-label {
            font-size: 0.9rem;
            color: var(--mystic-blue);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .best-move-card {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--royal-gold);
            margin-bottom: 1rem;
        }

        .engine-evaluation {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .eval-bar-container {
            width: 8px;
            height: 100%;
            min-height: 80px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .eval-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, var(--royal-gold), var(--mystic-blue));
            transition: height 0.5s ease;
        }

        .engine-analysis {
            color: var(--soft-white);
            line-height: 1.7;
            opacity: 0.9;
        }

        .engine-metrics {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .engine-metric {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .metric-label {
            color: var(--mystic-blue);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        .metric-value {
            color: var(--soft-white);
            font-weight: 600;
            font-size: 1rem;
        }

        /* AI Reasoning (compact for engine mode) */
        .ai-reasoning-panel {
            background: rgba(26, 26, 36, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            max-height: 300px;
            overflow-y: auto;
        }

        .reasoning-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border-left: 3px solid var(--mystic-blue);
            font-size: 0.85rem;
        }

        .reasoning-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .reasoning-ai-name {
            color: var(--royal-gold);
        }

        .reasoning-pick {
            color: var(--mystic-blue);
            font-size: 0.75rem;
        }

        .reasoning-card-name {
            font-weight: 600;
            color: var(--soft-white);
            margin-bottom: 0.25rem;
        }

        .reasoning-text {
            color: var(--soft-white);
            opacity: 0.85;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* Draft Screen */
        .draft-screen {
            max-width: 1400px;
            margin: 0 auto;
        }

        .draft-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .pick-info {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Cinzel', serif;
            color: var(--royal-gold);
        }

        .timer {
            font-size: 2rem;
            font-weight: 700;
            color: var(--mystic-blue);
            min-width: 80px;
            text-align: center;
        }

        .timer.warning {
            color: var(--mythic-orange);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pack-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(26, 26, 36, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1rem;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .card:hover {
            transform: translateY(-10px) scale(1.05);
            border-color: var(--royal-gold);
            box-shadow: 0 20px 40px rgba(212, 175, 55, 0.4);
            z-index: 10;
        }

        .card-image {
            width: 100%;
            height: 220px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
        }

        .card-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--soft-white);
        }

        .card-type {
            font-size: 0.75rem;
            color: var(--mystic-blue);
            margin-bottom: 0.5rem;
        }

        .card-rating {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.9);
            padding: 0.35rem 0.85rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.85rem;
            border: 2px solid var(--royal-gold);
            z-index: 5;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(212, 175, 55, 0.2);
            border-top-color: var(--royal-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1.5rem;
            font-size: 1.2rem;
            color: var(--mystic-blue);
        }

        /* Analysis Screen */
        .analysis-screen {
            max-width: 1200px;
            margin: 0 auto;
        }

        .grade-hero {
            text-align: center;
            padding: 3rem;
            background: linear-gradient(135deg, rgba(107, 70, 193, 0.3), rgba(74, 144, 226, 0.3));
            border-radius: 20px;
            margin-bottom: 3rem;
            border: 2px solid var(--royal-gold);
        }

        .grade-letter {
            font-family: 'Cinzel', serif;
            font-size: 6rem;
            font-weight: 700;
            color: var(--royal-gold);
            margin-bottom: 1rem;
        }

        .grade-subtitle {
            font-size: 1.5rem;
            color: var(--mystic-blue);
            margin-bottom: 0.5rem;
        }

        /* Cost Transparency Banner */
        .cost-banner {
            background: linear-gradient(135deg, rgba(107, 70, 193, 0.2), rgba(74, 144, 226, 0.2));
            border: 1px solid var(--mystic-blue);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .cost-info {
            font-size: 0.9rem;
            color: var(--soft-white);
        }

        .cost-value {
            font-weight: 700;
            color: var(--royal-gold);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .draft-screen-with-sidebar {
                grid-template-columns: 1fr;
            }
            
            .skills-sidebar {
                position: relative;
                top: 0;
            }
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .difficulty-grid {
                grid-template-columns: 1fr 1fr;
            }

            .pack-container {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .rubric-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .assessment-header {
                grid-template-columns: 1fr;
            }
            
            .panel-content {
                padding: 1.5rem;
            }
        }
        
        /* Skills Sidebar - V4 Addition */
        .draft-screen-with-sidebar {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
        }

        .skills-sidebar {
            background: rgba(26, 26, 36, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            position: sticky;
            top: 2rem;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }

        .sidebar-title {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--royal-gold);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .skill-item {
            margin-bottom: 1.5rem;
        }

        .skill-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .skill-name {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .skill-score {
            font-size: 1rem;
            font-weight: 700;
            color: var(--royal-gold);
        }

        .skill-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .skill-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--royal-gold), var(--mystic-blue));
            transition: width 0.5s ease;
        }

        .skill-tip {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        .overall-grade {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(74, 144, 226, 0.1));
            border-radius: 12px;
            border: 2px solid var(--royal-gold);
            margin-top: 1.5rem;
        }

        .grade-value {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            font-weight: 700;
            color: var(--royal-gold);
        }

        /* Slide-Up Feedback Panel - V4 Addition */
        .feedback-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(10, 10, 15, 0.98), rgba(26, 26, 36, 0.95));
            backdrop-filter: blur(20px);
            border-top: 2px solid var(--royal-gold);
            transform: translateY(100%);
            transition: transform 0.4s ease;
            z-index: 1000;
            max-height: 60vh;
            overflow-y: auto;
        }

        .feedback-panel.open {
            transform: translateY(0);
        }

        .panel-content {
            padding: 2.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .assessment-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .pick-card {
            text-align: center;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
        }

        .pick-card.yours {
            border: 3px solid var(--mystic-blue);
        }

        .pick-card.engine {
            border: 3px solid var(--royal-gold);
        }

        .pick-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 1rem;
        }

        .pick-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--soft-white);
        }

        .pick-rating {
            font-size: 1.2rem;
            color: var(--royal-gold);
            font-weight: 600;
        }

        .result-badge {
            display: inline-block;
            padding: 1rem 3rem;
            border-radius: 25px;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 2.5rem;
            letter-spacing: 1px;
        }

        /* MTG Draft Rating Hierarchy */
        .result-badge.premium {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(255, 215, 0, 0.2));
            border: 3px solid #d4af37;
            color: #ffd700;
        }

        .result-badge.strong {
            background: rgba(74, 222, 128, 0.2);
            border: 3px solid #4ade80;
            color: #4ade80;
        }

        .result-badge.solid {
            background: rgba(96, 165, 250, 0.2);
            border: 3px solid #60a5fa;
            color: #60a5fa;
        }

        .result-badge.loose {
            background: rgba(251, 191, 36, 0.2);
            border: 3px solid #fbbf24;
            color: #fbbf24;
        }

        .result-badge.shaky {
            background: rgba(251, 146, 60, 0.2);
            border: 3px solid #fb923c;
            color: #fb923c;
        }

        .result-badge.punt {
            background: rgba(239, 68, 68, 0.2);
            border: 3px solid #ef4444;
            color: #ef4444;
        }

        .result-badge.trainwreck {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.3), rgba(153, 27, 27, 0.2));
            border: 3px solid #dc2626;
            color: #ff6b6b;
        }

        .result-badge.genius {
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.3), rgba(139, 92, 246, 0.2));
            border: 3px solid #a78bfa;
            color: #c4b5fd;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(167, 139, 250, 0.4); }
            50% { box-shadow: 0 0 30px rgba(167, 139, 250, 0.6); }
        }

        /* AI Narrative Section */
        .narrative-section {
            background: linear-gradient(135deg, rgba(26, 26, 36, 0.8), rgba(42, 42, 56, 0.6));
            border-left: 4px solid var(--mystic-blue);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .narrative-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--mystic-blue);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .narrative-text {
            color: var(--soft-white);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .misconception-section {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), transparent);
            border-left: 4px solid var(--error-red);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .reflection-prompt {
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.1), transparent);
            border-left: 4px solid var(--royal-gold);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .reflection-text {
            color: var(--soft-white);
            line-height: 1.7;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        .reflection-input {
            width: 100%;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--soft-white);
            font-size: 1rem;
        }

        .rubric-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .rubric-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 5px solid var(--royal-gold);
            text-align: center;
        }

        .rubric-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rubric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--royal-gold);
        }

        .rubric-tip {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        .panel-button {
            background: linear-gradient(135deg, var(--royal-gold), var(--mystic-blue));
            color: var(--soft-white);
            border: none;
            padding: 1.5rem 3rem;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            font-size: 1.3rem;
            font-family: 'Cinzel', serif;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .panel-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.6);
        }

        /* Onboarding Modal */
        .onboarding-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 36, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 3rem;
            max-width: 800px;
            width: 90%;
            z-index: 1001;
            border: 2px solid var(--royal-gold);
            text-align: center;
        }

        .onboarding-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--royal-gold);
            margin-bottom: 1.5rem;
        }

        .onboarding-text {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .onboarding-list {
            text-align: left;
            margin-bottom: 2rem;
        }

        .onboarding-item {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .onboarding-icon {
            font-size: 1.5rem;
            color: var(--mystic-blue);
        }
    </style>
</head>
<body>
    <div id="magicBg"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Generate particles
        function generateParticles() {
            const bg = document.getElementById('magicBg');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.width = particle.style.height = (Math.random() * 4 + 2) + 'px';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
                bg.appendChild(particle);
            }
        }
        generateParticles();

        // ========================================
        // CONFIGURATION - UPDATE THIS!
        // ========================================
        
        // Scryfall API
        const SCRYFALL_API = 'https://api.scryfall.com';
        const SET_CODES = {
            'foundations': 'fdn',
            'duskmourn': 'dsk',
            'bloomburrow': 'blb',
            'modern-horizons-3': 'mh3',
            'outlaws': 'otj'
        };

        // Learning Outcomes - Measurable skills
        const LEARNING_OUTCOMES = {
            signal: {
                name: 'Signal Reading',
                desc: 'Identify open archetypes from pack contents and wheeling cards',
                tip: 'Look for strong cards passing late - signals open colors'
            },
            timing: {
                name: 'Color Timing',
                desc: 'Commit to colors at appropriate pick numbers',
                tip: 'Stay open early, commit by pack 1 pick 6-8'
            },
            curve: {
                name: 'Curve Balance',
                desc: 'Build efficient mana curve with proper distribution',
                tip: 'Aim for 5-7 two/three-drops, avoid too many high CMC'
            },
            synergy: {
                name: 'Synergy Building',
                desc: 'Select cards that interact positively',
                tip: 'Prioritize cards that fit your emerging themes'
            },
            quality: {
                name: 'Card Evaluation',
                desc: 'Assess raw power and contextual value',
                tip: 'Balance removal, bombs, and fillers'
            }
        };

        // Card rating with pedagogical weighting
        function estimateRating(card, currentDeck = []) {
            let base = 50;
            
            // Raw quality
            if (card.rarity === 'mythic') base = 95;
            else if (card.rarity === 'rare') base = 85;
            else if (card.rarity === 'uncommon') base = 70;
            else base = 55;
            
            // Type bonuses
            if (card.type_line.includes('Creature')) {
                const p = parseInt(card.power) || 0;
                const t = parseInt(card.toughness) || 0;
                const eff = (p + t) / (card.cmc + 1);
                base += eff * 10;
            } else if (card.type_line.includes('Removal') || card.oracle_text.includes('destroy')) {
                base += 20;
            }
            
            // Synergy with deck
            if (currentDeck.length > 0) {
                const colorMatch = currentDeck.filter(c => c.colors.some(col => card.colors.includes(col))).length / currentDeck.length;
                base += colorMatch * 15;
            }
            
            // Clamp and letter grade
            base = Math.min(100, Math.max(30, base));
            if (base >= 95) return 'A+';
            if (base >= 85) return 'A';
            if (base >= 80) return 'A-';
            if (base >= 75) return 'B+';
            if (base >= 65) return 'B';
            if (base >= 60) return 'B-';
            if (base >= 50) return 'C+';
            if (base >= 40) return 'C';
            return 'C-';
        }

        // Fetch cards
        async function fetchSetCards(setCode) {
            try {
                const response = await fetch(`${SCRYFALL_API}/cards/search?q=set:${setCode}+-is:reprint&unique=prints`);
                if (!response.ok) {
                    throw new Error(`Scryfall API error: ${response.status}`);
                }
                const data = await response.json();
                
                return data.data.map(card => ({
                    id: card.id,
                    name: card.name,
                    type: card.type_line,
                    cmc: card.cmc,
                    colors: card.colors || [],
                    rarity: card.rarity,
                    image: card.image_uris?.normal || card.card_faces?.[0]?.image_uris?.normal,
                    oracle_text: card.oracle_text || '',
                    power: card.power,
                    toughness: card.toughness
                }));
            } catch (error) {
                console.error('Scryfall error:', error);
                throw error;
            }
        }

        // Generate pack with procedural variation for replayability
        async function generatePack(setCode, allCards, difficulty) {
            const commons = allCards.filter(c => c.rarity === 'common');
            const uncommons = allCards.filter(c => c.rarity === 'uncommon');
            const raresAndMythics = allCards.filter(c => c.rarity === 'rare' || c.rarity === 'mythic');
            const pack = [];
            
            // Adaptive pack generation based on difficulty
            const rareChance = {
                common: 0.3,
                uncommon: 0.5,
                rare: 0.7,
                mythic: 0.9
            }[difficulty];
            
            if (Math.random() < rareChance && raresAndMythics.length > 0) {
                pack.push(raresAndMythics[Math.floor(Math.random() * raresAndMythics.length)]);
            } else if (uncommons.length > 0) {
                pack.push(uncommons[Math.floor(Math.random() * uncommons.length)]);
            }
            
            for (let i = 0; i < 3 && uncommons.length > 0; i++) {
                const card = uncommons[Math.floor(Math.random() * uncommons.length)];
                if (!pack.find(c => c.id === card.id)) {
                    pack.push(card);
                }
            }
            
            while (pack.length < 15 && commons.length > 0) {
                const card = commons[Math.floor(Math.random() * commons.length)];
                if (!pack.find(c => c.id === card.id)) {
                    pack.push(card);
                }
            }
            
            return pack;
        }

        // Main Component
        function DraftSimulator() {
            const [screen, setScreen] = useState('setup');
            const [set, setSet] = useState('foundations');
            const [difficulty, setDifficulty] = useState('mythic'); // common, uncommon, rare, mythic
            const [engineAnalysis, setEngineAnalysis] = useState(true);
            const [showAIReasoning, setShowAIReasoning] = useState(true);
            const [proxyEndpoint, setProxyEndpoint] = useState('');
            const [showOnboarding, setShowOnboarding] = useState(true);
            const [loading, setLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            
            const [allCards, setAllCards] = useState([]);
            const [currentPack, setCurrentPack] = useState(1);
            const [currentPick, setCurrentPick] = useState(1);
            const [allPacks, setAllPacks] = useState([]);
            const [allPlayers, setAllPlayers] = useState([]);
            const [timer, setTimer] = useState(60);
            
            const [aiReasoning, setAiReasoning] = useState([]);
            const [bestMove, setBestMove] = useState(null);
            
            const [totalCost, setTotalCost] = useState(0);
            const [apiCalls, setApiCalls] = useState(0);
            
            const [grade, setGrade] = useState('');
            const [analysis, setAnalysis] = useState(null);

            // Telemetry and Analytics
            const [sessionTelemetry, setSessionTelemetry] = useState([]);
            const logTelemetry = (event, data) => {
                setSessionTelemetry(prev => [...prev, {
                    timestamp: Date.now(),
                    event,
                    data
                }]);
            };

            // Tutoring state with persistence for spaced practice
            const [skills, setSkills] = useState(Object.keys(LEARNING_OUTCOMES).reduce((acc, key) => {
                acc[key] = { score: 0, picks: 0, history: [] };
                return acc;
            }, {}));
            const [showPanel, setShowPanel] = useState(false);
            const [assessment, setAssessment] = useState(null);
            const [reflectionResponse, setReflectionResponse] = useState('');

            // Adaptive difficulty calibration
            const [adaptiveDiff, setAdaptiveDiff] = useState(difficulty);

            // Check if running from file protocol
            useEffect(() => {
                if (window.location.protocol === 'file:') {
                    alert('This application requires a web server to function properly due to browser security restrictions. Please run it through a local server (e.g., Python -m http.server) or host it online.');
                }
            }, []);

            // Timer with scaffolding
            useEffect(() => {
                if (screen === 'draft' && timer > 0) {
                    const interval = setInterval(() => {
                        setTimer(t => t - 1);
                    }, 1000);
                    return () => clearInterval(interval);
                } else if (timer === 0 && allPacks.length > 0 && allPacks[0]?.length > 0) {
                    handlePick(allPacks[0][0], 0);
                }
            }, [screen, timer, allPacks]);

            const startDraft = async () => {
                if (showOnboarding) {
                    setShowOnboarding(false);
                }
                setLoading(true);
                setLoadingMessage('Initializing learning environment...');
                
                try {
                    const setCode = SET_CODES[set] || 'fdn';
                    const cards = await fetchSetCards(setCode);
                    setAllCards(cards);
                    
                    setLoadingMessage('Generating procedural packs...');
                    
                    const packs = [];
                    for (let i = 0; i < 8; i++) {
                        packs.push(await generatePack(setCode, cards, adaptiveDiff));
                    }
                    
                    const players = Array(8).fill(null).map((_, i) => ({
                        id: i,
                        name: i === 0 ? 'You' : `AI ${i}`,
                        picks: [],
                        isAI: i !== 0
                    }));
                    
                    setAllPacks(packs);
                    setAllPlayers(players);
                    setCurrentPack(1);
                    setCurrentPick(1);
                    setTimer(60);
                    setAiReasoning([]);
                    setTotalCost(0);
                    setApiCalls(0);
                    setSessionTelemetry([]);
                    setScreen('draft');
                    logTelemetry('draft_start', { set, difficulty: adaptiveDiff });
                    
                    if (engineAnalysis) {
                        await getEngineAnalysis(packs[0], players[0].picks);
                    }
                } catch (error) {
                    console.error('Error starting draft:', error);
                    alert(`Error initializing session: ${error.message}. Please check console for details and retry.`);
                } finally {
                    setLoading(false);
                    setLoadingMessage('');
                }
            };

            // Call Claude API via proxy with pedagogical prompts
            const callClaudeAPI = async (pack, currentPicks, playerName, packNum, pickNum, customPrompt = null) => {
                if (!proxyEndpoint) {
                    return simpleAIPick(pack, currentPicks);
                }
                try {
                    // Enhanced prompt with learning frameworks
                    const promptContent = customPrompt || `You are an AI tutor teaching MTG Limited drafting at ${adaptiveDiff.toUpperCase()} level for set ${set}.

Current: Pack ${packNum}, Pick ${pickNum}
Student's deck (${currentPicks.length} cards): ${currentPicks.map(c => `${c.name} (${c.rating})`).join(', ') || 'None yet'}

Pack (${pack.length} cards):
${pack.map(c => `- ${c.name} (${c.type}, ${c.colors.join('/')}, Rating: ${c.rating})`).join('\n')}

Tutoring guidelines:
- Scaffold: Build on previous picks, explain concepts progressively
- Metacognition: Prompt reflection on strategy
- Adaptive: ${adaptiveDiff === 'common' ? 'Introduce basic concepts' : adaptiveDiff === 'uncommon' ? 'Reinforce fundamentals' : adaptiveDiff === 'rare' ? 'Teach advanced signals' : 'Optimize expert strategies'}
- Assessment: Evaluate vs learning outcomes: signal reading, timing, curve, synergy, quality

Recommend best card. Provide reasoning tied to outcomes. Suggest reflection question.

Format:
PICK: [exact card name]
REASONING: [2-3 sentences, pedagogical]
REFLECTION: [1 metacognitive prompt]`;

                    const response = await fetch(proxyEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-5-20250929',
                            max_tokens: customPrompt ? 300 : 500,
                            messages: [{
                                role: 'user',
                                content: promptContent
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Proxy error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.fallback) {
                        return simpleAIPick(pack, currentPicks);
                    }
                    
                    const inputTokens = data.usage?.input_tokens || 0;
                    const outputTokens = data.usage?.output_tokens || 0;
                    const cost = (inputTokens * 0.000003) + (outputTokens * 0.000015);
                    
                    setTotalCost(prev => prev + cost);
                    setApiCalls(prev => prev + 1);
                    
                    const text = data.content[0].text;
                    
                    if (customPrompt) {
                        return { card: null, reasoning: text.trim(), cost };
                    }
                    
                    const pickMatch = text.match(/PICK:\s*(.+)/i);
                    const reasoningMatch = text.match(/REASONING:\s*(.+?)(?=REFLECTION|$)/is);
                    const reflectionMatch = text.match(/REFLECTION:\s*(.+)/is);
                    
                    const pickedCardName = pickMatch ? pickMatch[1].trim() : null;
                    const reasoning = reasoningMatch ? reasoningMatch[1].trim() : 'Strategic pick';
                    const reflection = reflectionMatch ? reflectionMatch[1].trim() : 'Why this pick?';
                    
                    const pickedCard = pack.find(c => 
                        c.name.toLowerCase() === pickedCardName?.toLowerCase()
                    ) || pack[0];
                    
                    return { card: pickedCard, reasoning, reflection, cost };
                } catch (error) {
                    console.error('API error:', error);
                    return simpleAIPick(pack, currentPicks);
                }
            };

            // Fallback simple AI with basic teaching
            const simpleAIPick = (pack, currentPicks) => {
                const ratingValues = { 'A+': 100, 'A': 90, 'A-': 85, 'B+': 80, 'B': 70, 'B-': 60, 'C+': 50, 'C': 40, 'C-': 30 };
                const sorted = [...pack].sort((a, b) => (ratingValues[b.rating] || 50) - (ratingValues[a.rating] || 50));
                return { 
                    card: sorted[0], 
                    reasoning: 'Selected highest quality card to demonstrate evaluation basics.', 
                    reflection: 'What makes this card high quality?',
                    cost: 0 
                };
            };

            // Engine analysis with tutoring
            const getEngineAnalysis = async (pack, currentPicks) => {
                if (!engineAnalysis) return;
                
                setLoadingMessage('Tutor analyzing position...');
                
                const result = await callClaudeAPI(pack, currentPicks, 'Tutor', currentPack, currentPick);
                
                setBestMove({
                    card: result.card,
                    reasoning: result.reasoning,
                    reflection: result.reflection,
                    evaluation: Math.min(95, 60 + currentPicks.length * 2 + (Object.values(skills).reduce((sum, s) => sum + (s.picks > 0 ? s.score / s.picks : 0), 0) / 5) * 0.3)
                });
            };

            const handlePick = async (card, playerIndex = 0) => {
                const startTime = Date.now();
                const newPlayers = [...allPlayers];
                newPlayers[playerIndex].picks.push({
                    ...card,
                    packNum: currentPack,
                    pickNum: currentPick,
                    rating: estimateRating(card, newPlayers[playerIndex].picks)
                });
                
                if (playerIndex === 0 && bestMove) {
                    logTelemetry('player_pick', {
                        card: card.name,
                        time: Date.now() - startTime,
                        packSize: allPacks[0].length,
                        skills: {...skills}
                    });
                    
                    const isOptimal = card.id === bestMove.card.id;
                    const ratingVals = { 'A+': 100, 'A': 90, 'A-': 85, 'B+': 80, 'B': 70, 'B-': 60, 'C+': 50, 'C': 40, 'C-': 30 };
                    
                    const qualityScore = ratingVals[card.rating] || 50;
                    const curveScore = calculateCurveScore(newPlayers[0].picks);
                    const timingScore = calculateTimingScore(currentPick, newPlayers[0].picks);
                    const signalScore = calculateSignalScore(allPacks[0].length);
                    const synergyScore = calculateSynergyScore(newPlayers[0].picks, card);
                    
                    const yourValue = ratingVals[card.rating] || 50;
                    const engineValue = ratingVals[bestMove.card.rating] || 50;
                    const ewrLoss = (engineValue - yourValue) / 100;
                    
                    let classification, classColor;
                    if (ewrLoss <= 0.05) {
                        classification = 'Premium Pick';
                        classColor = 'premium';
                    } else if (ewrLoss <= 0.10) {
                        classification = 'Strong Pick';
                        classColor = 'strong';
                    } else if (ewrLoss <= 0.15) {
                        classification = 'Solid Pick';
                        classColor = 'solid';
                    } else if (ewrLoss <= 0.25) {
                        classification = 'Loose Pick';
                        classColor = 'loose';
                    } else if (ewrLoss <= 0.35) {
                        classification = 'Shaky Pick';
                        classColor = 'shaky';
                    } else if (ewrLoss <= 0.50) {
                        classification = 'Punt';
                        classColor = 'punt';
                    } else {
                        classification = 'Trainwreck';
                        classColor = 'trainwreck';
                    }
                    
                    const wheeled = allPacks[0].length >= 8;
                    if (ewrLoss <= 0.10 && wheeled) {
                        classification = 'Genius Read';
                        classColor = 'genius';
                    }
                    
                    setLoadingMessage('Generating personalized feedback...');
                    
                    let narrative = 'Evaluating position...';
                    let misconception = null;
                    let reflection = bestMove.reflection;
                    
                    const narrativePrompt = `As an MTG draft tutor, provide formative feedback on this pick in 2-3 sentences. Align to learning outcomes.

Student Pick: ${card.name} (${card.rating}, ${card.cmc} CMC, ${card.colors.join('/') || 'Colorless'})
Tutor Recommendation: ${bestMove.card.name} (${bestMove.card.rating})

Deck Summary: ${newPlayers[0].picks.length} cards, Curve: Low ${lowCurveCount(newPlayers[0].picks)} / Mid ${midCurveCount(newPlayers[0].picks)} / High ${highCurveCount(newPlayers[0].picks)}
Performance: Quality ${qualityScore}%, Curve ${curveScore}%, Timing ${timingScore}%, Signal ${signalScore}%, Synergy ${synergyScore}%

Classification: ${classification}

If suboptimal, detect misconception and explain correction in 1 sentence.
Focus on growth mindset, specific advice for next picks.`;

                    try {
                        const narrativeResult = await callClaudeAPI(
                            [],
                            newPlayers[0].picks,
                            'Tutor',
                            currentPack,
                            currentPick,
                            narrativePrompt
                        );
                        
                        const parts = narrativeResult.reasoning.split('\n\n');
                        narrative = parts[0] || narrativeResult.reasoning;
                        if (parts[1]) misconception = parts[1];
                    } catch (err) {
                        narrative = generateFallbackNarrative(classification, ewrLoss, wheeled, card, bestMove.card);
                        if (ewrLoss > 0.15) {
                            misconception = generateFallbackMisconception(ewrLoss, card, bestMove.card);
                        }
                    }
                    
                    // Update skills with history for analytics
                    setSkills(prev => {
                        const newSkills = {...prev};
                        Object.entries({
                            signal: signalScore,
                            timing: timingScore,
                            curve: curveScore,
                            synergy: synergyScore,
                            quality: qualityScore
                        }).forEach(([key, score]) => {
                            newSkills[key].history.push(score);
                            newSkills[key].score += score;
                            newSkills[key].picks += 1;
                        });
                        return newSkills;
                    });
                    
                    // Adaptive difficulty
                    const avgSkill = Object.values(skills).reduce((sum, s) => sum + (s.picks > 0 ? s.score / s.picks : 0), 0) / 5;
                    if (avgSkill > 85 && adaptiveDiff !== 'mythic') {
                        setAdaptiveDiff('mythic');
                    } else if (avgSkill < 60 && adaptiveDiff !== 'common') {
                        setAdaptiveDiff('common');
                    }
                    
                    setAssessment({
                        isOptimal,
                        yourPick: card,
                        enginePick: bestMove.card,
                        classification,
                        classColor,
                        ewrLoss: Math.round(ewrLoss * 100),
                        narrative,
                        misconception,
                        reflection,
                        rubric: {
                            quality: Math.round(qualityScore),
                            curve: Math.round(curveScore),
                            timing: Math.round(timingScore),
                            signal: Math.round(signalScore),
                            synergy: Math.round(synergyScore)
                        }
                    });
                    
                    setReflectionResponse('');
                    setShowPanel(true);
                    return;
                }
                
                setAllPlayers(newPlayers);
                
                const newPacks = [...allPacks];
                newPacks[playerIndex] = newPacks[playerIndex].filter(c => c.id !== card.id);
                setAllPacks(newPacks);
            };

            // Helper functions for scoring
            const lowCurveCount = picks => picks.filter(p => p.cmc <= 2).length;
            const midCurveCount = picks => picks.filter(p => p.cmc === 3 || p.cmc === 4).length;
            const highCurveCount = picks => picks.filter(p => p.cmc >= 5).length;

            const calculateCurveScore = picks => {
                const total = picks.length;
                if (total === 0) return 75;
                const low = lowCurveCount(picks) / total;
                const mid = midCurveCount(picks) / total;
                const high = highCurveCount(picks) / total;
                return Math.round(100 - Math.abs(low - 0.3)*100 - Math.abs(mid - 0.5)*100 - Math.abs(high - 0.2)*100);
            };

            const calculateTimingScore = (pickNum, picks) => {
                const committed = picks.some(p => p.colors.length > 0);
                if (pickNum <= 5 && committed) return 60; // Too early commit
                if (pickNum >= 8 && !committed) return 60; // Too late
                return 90;
            };

            const calculateSignalScore = packSize => {
                return packSize >= 8 ? 90 : 70; // Wheeling bonus
            };

            const calculateSynergyScore = (picks, newCard) => {
                if (picks.length === 0) return 75;
                const colorMatches = picks.filter(p => p.colors.some(c => newCard.colors.includes(c))).length / picks.length;
                const typeSynergy = picks.filter(p => p.type === newCard.type).length / picks.length > 0.4 ? -20 : 20;
                return Math.round(colorMatches * 80 + typeSynergy);
            };

            const generateFallbackNarrative = (classification, ewrLoss, wheeled, card, engineCard) => {
                if (ewrLoss === 0) return `Excellent demonstration of card evaluation. This pick aligns perfectly with optimal strategy, strengthening your deck's fundamentals. Focus on maintaining this level in future picks.`;
                if (ewrLoss <= 0.10 && wheeled) return `Strong signal reading skill shown. Recognizing wheeled cards indicates good archetype awareness. Build on this by prioritizing synergies next.`;
                if (ewrLoss <= 0.15) return `Solid choice that fits your strategy. While not optimal, it maintains deck balance. Consider curve implications for your next selection.`;
                return `This pick shows room for growth in evaluation. ${card.name} is playable but ${engineCard.name} better addresses deck needs. Review signals for improvement.`;
            };

            const generateFallbackMisconception = (ewrLoss, card, engineCard) => {
                if (ewrLoss > 0.3) return `Possible misconception: Overvaluing raw power without context. Remember, card value depends on deck synergy and curve.`;
                return `Potential oversight in signal reading. Late strong cards indicate open lanes - prioritize them to optimize your archetype.`;
            };

            // Continue after reflection
            const continueAfterAssessment = async () => {
                if (reflectionResponse.trim() === '') {
                    alert('Please enter your reflection to proceed - this reinforces learning!');
                    return;
                }
                
                logTelemetry('reflection', { prompt: assessment.reflection, response: reflectionResponse });
                
                setShowPanel(false);
                
                const newPlayers = [...allPlayers];
                const newPacks = [...allPacks];
                
                setLoading(true);
                setLoadingMessage('Opponents responding...');
                const newReasoning = [];
                
                for (let i = 1; i < 8; i++) {
                    if (newPacks[i] && newPacks[i].length > 0) {
                        const result = await callClaudeAPI(
                            newPacks[i],
                            newPlayers[i].picks,
                            newPlayers[i].name,
                            currentPack,
                            currentPick
                        );
                        
                        newPlayers[i].picks.push({
                            ...result.card,
                            packNum: currentPack,
                            pickNum: currentPick,
                            rating: estimateRating(result.card, newPlayers[i].picks)
                        });
                        
                        newPacks[i] = newPacks[i].filter(c => c.id !== result.card.id);
                        
                        if (showAIReasoning) {
                            newReasoning.push({
                                player: newPlayers[i].name,
                                card: result.card.name,
                                reasoning: result.reasoning,
                                reflection: result.reflection,
                                pick: `P${currentPack}P${currentPick}`
                            });
                        }
                    }
                }
                
                setAllPlayers(newPlayers);
                setAiReasoning(prev => [...newReasoning, ...prev].slice(0, 15));
                
                const passedPacks = [...newPacks];
                if (currentPack % 2 === 1) {
                    passedPacks.unshift(passedPacks.pop());
                } else {
                    passedPacks.push(passedPacks.shift());
                }
                setAllPacks(passedPacks);
                
                if (currentPick === 15) {
                    if (currentPack === 3) {
                        await analyzeDraft(newPlayers[0].picks);
                        setScreen('analysis');
                        setLoading(false);
                        return;
                    }
                    
                    setLoadingMessage('Preparing next pack with adaptive content...');
                    const newPacks2 = [];
                    for (let i = 0; i < 8; i++) {
                        newPacks2.push(await generatePack(SET_CODES[set], allCards, adaptiveDiff));
                    }
                    setAllPacks(newPacks2);
                    setCurrentPack(currentPack + 1);
                    setCurrentPick(1);
                    
                    if (engineAnalysis) {
                        await getEngineAnalysis(newPacks2[0], newPlayers[0].picks);
                    }
                } else {
                    setCurrentPick(currentPick + 1);
                    
                    if (engineAnalysis) {
                        await getEngineAnalysis(passedPacks[0], newPlayers[0].picks);
                    }
                }
                
                setTimer(60);
                setLoading(false);
                setLoadingMessage('');
            };

            const analyzeDraft = async (picks) => {
                setLoading(true);
                setLoadingMessage('Compiling learning analytics...');
                
                const curve = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, '6+': 0 };
                picks.forEach(card => {
                    const cmc = card.cmc || 0;
                    if (cmc >= 6) curve['6+']++;
                    else curve[cmc]++;
                });

                const colors = { W: 0, U: 0, B: 0, R: 0, G: 0 };
                picks.forEach(card => {
                    card.colors.forEach(c => colors[c]++);
                });

                const sortedColors = Object.entries(colors).sort((a, b) => b[1] - a[1]);
                const primaryColors = sortedColors.slice(0, 2).map(([c]) => c);

                const ratingValues = { 'A+': 100, 'A': 90, 'A-': 85, 'B+': 80, 'B': 70, 'B-': 60, 'C+': 50, 'C': 40, 'C-': 30 };
                const avgRating = picks.reduce((sum, card) => sum + (ratingValues[card.rating] || 50), 0) / picks.length;
                const curveScore = calculateCurveScore(picks);
                const colorScore = sortedColors[0][1] >= 12 && sortedColors[1][1] >= 8 ? 90 : 70;
                
                const overall = (avgRating * 0.4) + (curveScore * 0.3) + (colorScore * 0.3);
                
                let gradeLetter;
                if (overall >= 90) gradeLetter = 'A+';
                else if (overall >= 85) gradeLetter = 'A';
                else if (overall >= 80) gradeLetter = 'A-';
                else if (overall >= 75) gradeLetter = 'B+';
                else if (overall >= 70) gradeLetter = 'B';
                else if (overall >= 65) gradeLetter = 'B-';
                else gradeLetter = 'C+';

                // Summative assessment
                const skillAverages = Object.fromEntries(Object.entries(skills).map(([key, s]) => [key, s.picks > 0 ? Math.round(s.score / s.picks) : 0]));
                
                logTelemetry('draft_complete', { grade: gradeLetter, skills: skillAverages, telemetry: sessionTelemetry });

                setGrade(gradeLetter);
                setAnalysis({ curve, colors, primaryColors, skillAverages });
                setLoading(false);
            };

            const resetDraft = () => {
                setScreen('setup');
                setAllPlayers([]);
                setAllPacks([]);
                setAiReasoning([]);
                setBestMove(null);
                setGrade('');
                setAnalysis(null);
                setSkills(Object.keys(LEARNING_OUTCOMES).reduce((acc, key) => {
                    acc[key] = { score: 0, picks: 0, history: [] };
                    return acc;
                }, {}));
                setAdaptiveDiff(difficulty);
            };

            const difficultyConfig = {
                common: {
                    icon: '',
                    name: 'Common',
                    desc: 'Introductory: Basic concepts with guidance',
                    class: 'common'
                },
                uncommon: {
                    icon: '',
                    name: 'Uncommon',
                    desc: 'Intermediate: Reinforce fundamentals',
                    class: 'uncommon'
                },
                rare: {
                    icon: '',
                    name: 'Rare',
                    desc: 'Advanced: Complex strategies',
                    class: 'rare'
                },
                mythic: {
                    icon: '',
                    name: 'Mythic',
                    desc: 'Expert: Optimal playtesting',
                    class: 'mythic'
                }
            };

            return (
                <div id="app">
                    {loading && (
                        <div className="loading-overlay">
                            <div className="loading-spinner"></div>
                            <div className="loading-text">{loadingMessage || 'Loading...'}</div>
                        </div>
                    )}

                    <div className="header">
                        <h1 className="title">MTG Draft Tutor</h1>
                        <p className="subtitle">Engineered for Mastery: Learn Through Play</p>
                        <div className="api-badge"> AI-Powered Tutoring</div>
                    </div>

                    {showOnboarding && (
                        <div className="onboarding-modal">
                            <h2 className="onboarding-title">Welcome to Draft Mastery</h2>
                            <p className="onboarding-text">
                                This interactive simulator teaches MTG Limited drafting through guided practice. 
                                Every decision assesses and builds your skills.
                            </p>
                            <div className="onboarding-list">
                                <div className="onboarding-item">
                                    <span className="onboarding-icon"></span>
                                    <div>Track progress in 5 key outcomes: signals, timing, curve, synergy, quality</div>
                                </div>
                                <div className="onboarding-item">
                                    <span className="onboarding-icon"></span>
                                    <div>AI tutor provides personalized feedback and detects misconceptions</div>
                                </div>
                                <div className="onboarding-item">
                                    <span className="onboarding-icon"></span>
                                    <div>Adaptive difficulty scales to your performance</div>
                                </div>
                                <div className="onboarding-item">
                                    <span className="onboarding-icon"></span>
                                    <div>Reflect after picks to reinforce learning</div>
                                </div>
                            </div>
                            <button className="button" onClick={startDraft}>
                                Begin Learning
                            </button>
                        </div>
                    )}

                    {screen === 'setup' && !showOnboarding && (
                        <div className="setup-screen">
                            {totalCost > 0 && (
                                <div className="cost-banner">
                                    <div className="cost-info">
                                        Session costs covered - focus on learning! 
                                    </div>
                                    <div className="cost-info">
                                        API Usage: <span className="cost-value">${totalCost.toFixed(3)}</span>
                                    </div>
                                </div>
                            )}

                            <div className="setup-card">
                                <h2 className="section-title">Configure Session</h2>
                                
                                <div className="form-group">
                                    <label className="form-label">Set Selection</label>
                                    <select
                                        className="form-select"
                                        value={set}
                                        onChange={(e) => setSet(e.target.value)}
                                    >
                                        <option value="foundations">Foundations</option>
                                        <option value="duskmourn">Duskmourn</option>
                                        <option value="bloomburrow">Bloomburrow</option>
                                        <option value="modern-horizons-3">Modern Horizons 3</option>
                                        <option value="outlaws">Outlaws of Thunder Junction</option>
                                    </select>
                                    <div className="form-help">Choose set to practice specific metagame</div>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Starting Difficulty</label>
                                    <div className="difficulty-grid">
                                        {Object.entries(difficultyConfig).map(([key, config]) => (
                                            <div
                                                key={key}
                                                className={`difficulty-option ${config.class} ${difficulty === key ? 'selected' : ''}`}
                                                onClick={() => setDifficulty(key)}
                                            >
                                                <div className="difficulty-icon">{config.icon}</div>
                                                <div className="difficulty-name">{config.name}</div>
                                                <div className="difficulty-desc">{config.desc}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="form-help">Adapts automatically based on performance</div>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Claude Proxy Endpoint</label>
                                    <input
                                        className="form-input"
                                        type="text"
                                        value={proxyEndpoint}
                                        onChange={(e) => setProxyEndpoint(e.target.value)}
                                        placeholder="https://mtg-draft-proxy.summerofwisteria.workers.dev/"
                                    />
                                    <div className="form-help">Optional: Your Cloudflare Worker URL proxying to Claude API. If not provided, basic local AI will be used.</div>
                                </div>

                                <div className="form-group">
                                    <div className="checkbox-group">
                                        <input
                                            type="checkbox"
                                            id="engineAnalysis"
                                            checked={engineAnalysis}
                                            onChange={(e) => setEngineAnalysis(e.target.checked)}
                                        />
                                        <label htmlFor="engineAnalysis" className="form-label" style={{marginBottom: 0}}>
                                            Enable AI Tutor (recommended picks & feedback)
                                        </label>
                                    </div>
                                    <div className="form-help">
                                        Provides scaffolding and formative assessment (uses proxy if provided, else fallback)
                                    </div>
                                </div>

                                <div className="form-group">
                                    <div className="checkbox-group">
                                        <input
                                            type="checkbox"
                                            id="showReasoning"
                                            checked={showAIReasoning}
                                            onChange={(e) => setShowAIReasoning(e.target.checked)}
                                        />
                                        <label htmlFor="showReasoning" className="form-label" style={{marginBottom: 0}}>
                                            Show Opponent Reasoning
                                        </label>
                                    </div>
                                    <div className="form-help">
                                        Observe AI strategies for vicarious learning
                                    </div>
                                </div>
                            </div>

                            <button className="button" onClick={startDraft}>
                                Launch Draft
                            </button>
                        </div>
                    )}

                    {screen === 'draft' && allPacks.length > 0 && (
                        <div className="draft-screen-with-sidebar">
                            <div>
                                <div className="draft-header">
                                    <div className="pick-info">
                                        Pack {currentPack}, Pick {currentPick}
                                    </div>
                                    <div className={`timer ${timer <= 10 ? 'warning' : ''}`}>
                                        {timer}s
                                    </div>
                                </div>

                                {engineAnalysis && bestMove && (
                                    <div className="engine-panel">
                                        <div className="engine-header">
                                            <div className="engine-icon"></div>
                                            <div>
                                                <div className="engine-title">AI Tutor Recommendation</div>
                                                <div className="engine-subtitle">Adaptive Depth: {adaptiveDiff}</div>
                                            </div>
                                        </div>
                                        <div className="best-move-display">
                                            <div className="best-move-label">Suggested Pick</div>
                                            <div className="best-move-card">{bestMove.card.name}</div>
                                            <div className="engine-evaluation">
                                                <div className="eval-bar-container">
                                                    <div 
                                                        className="eval-bar" 
                                                        style={{height: `${bestMove.evaluation}%`}}
                                                    />
                                                </div>
                                                <div>
                                                    <div className="engine-analysis">{bestMove.reasoning}</div>
                                                    <div className="engine-metrics">
                                                        <div className="engine-metric">
                                                            <div className="metric-label">Position Score</div>
                                                            <div className="metric-value">{bestMove.evaluation}%</div>
                                                        </div>
                                                        <div className="engine-metric">
                                                            <div className="metric-label">Card Rating</div>
                                                            <div className="metric-value">{bestMove.card.rating}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {showAIReasoning && aiReasoning.length > 0 && (
                                    <div className="ai-reasoning-panel">
                                        <h3 className="section-title" style={{fontSize: '1rem', marginBottom: '1rem'}}>
                                            Opponent Strategies
                                        </h3>
                                        {aiReasoning.map((r, idx) => (
                                            <div key={idx} className="reasoning-item">
                                                <div className="reasoning-header">
                                                    <span className="reasoning-ai-name">{r.player}</span>
                                                    <span className="reasoning-pick">{r.pick}</span>
                                                </div>
                                                <div className="reasoning-card-name">{r.card}</div>
                                                <div className="reasoning-text">{r.reasoning}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                <h3 className="section-title" style={{marginBottom: '1.5rem'}}>
                                    Select Your Card ({allPacks[0]?.length || 0} options)
                                </h3>
                                
                                <div className="pack-container">
                                    {allPacks[0]?.map(card => (
                                        <div
                                            key={card.id}
                                            className="card"
                                            onClick={() => handlePick({...card, rating: estimateRating(card, allPlayers[0].picks)}, 0)}
                                        >
                                            {card.image && (
                                                <img src={card.image} alt={card.name} className="card-image" />
                                            )}
                                            <div className="card-rating">{estimateRating(card, allPlayers[0].picks)}</div>
                                            <div className="card-name">{card.name}</div>
                                            <div className="card-type">{card.type}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="skills-sidebar">
                                <div className="sidebar-title">Learning Progress</div>
                                
                                {Object.entries(LEARNING_OUTCOMES).map(([key, {name, tip}]) => {
                                    const avg = skills[key].picks > 0 ? Math.round(skills[key].score / skills[key].picks) : 0;
                                    return (
                                        <div key={key} className="skill-item">
                                            <div className="skill-header">
                                                <div className="skill-name">{name}</div>
                                                <div className="skill-score">{avg}%</div>
                                            </div>
                                            <div className="skill-bar">
                                                <div className="skill-fill" style={{width: `${avg}%`}} />
                                            </div>
                                            <div className="skill-tip">{tip}</div>
                                        </div>
                                    );
                                })}
                                
                                <div className="overall-grade">
                                    <div style={{fontSize: '0.8rem', opacity: 0.7, marginBottom: '0.5rem'}}>
                                        Session Grade
                                    </div>
                                    <div className="grade-value">
                                        {(() => {
                                            const avg = Object.values(skills).reduce((sum, s) => {
                                                return sum + (s.picks > 0 ? s.score / s.picks : 0);
                                            }, 0) / 5;
                                            if (avg >= 90) return 'A+';
                                            if (avg >= 85) return 'A';
                                            if (avg >= 80) return 'A-';
                                            if (avg >= 75) return 'B+';
                                            if (avg >= 70) return 'B';
                                            return 'B-';
                                        })()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {screen === 'analysis' && analysis && (
                        <div className="analysis-screen">
                            <div className="grade-hero">
                                <div className="grade-letter">{grade}</div>
                                <div className="grade-subtitle">Mastery Achieved</div>
                            </div>

                            <div className="narrative-section">
                                <div className="narrative-label">Debrief Summary</div>
                                <div className="narrative-text">
                                    Your deck features {analysis.primaryColors.join('-')} colors with a {Object.values(analysis.curve).reduce((a,b)=>a+b,0)} card pool. 
                                    Strengths: {Object.entries(analysis.skillAverages).sort((a,b)=>b[1]-a[1])[0][0]} at {Object.entries(analysis.skillAverages).sort((a,b)=>b[1]-a[1])[0][1]}%.
                                    Growth area: {Object.entries(analysis.skillAverages).sort((a,b)=>a[1]-b[1])[0][0]} - review {LEARNING_OUTCOMES[Object.entries(analysis.skillAverages).sort((a,b)=>a[1]-b[1])[0][0]].tip}.
                                </div>
                            </div>

                            <div className="rubric-grid">
                                {Object.entries(analysis.skillAverages).map(([key, score]) => (
                                    <div key={key} className="rubric-item">
                                        <div className="rubric-label">
                                            {LEARNING_OUTCOMES[key].name}
                                        </div>
                                        <div className="rubric-value">{score}%</div>
                                        <div className="rubric-tip">{LEARNING_OUTCOMES[key].tip}</div>
                                    </div>
                                ))}
                            </div>

                            <button className="button" onClick={resetDraft}>
                                Replay for Mastery
                            </button>
                        </div>
                    )}

                    {showPanel && assessment && (
                        <div className={`feedback-panel ${showPanel ? 'open' : ''}`}>
                            <div className="panel-content">
                                <div style={{textAlign: 'center'}}>
                                    <div className={`result-badge ${assessment.classColor}`}>
                                        {assessment.classification}
                                    </div>
                                    {assessment.ewrLoss > 0 && (
                                        <div style={{
                                            fontSize: '0.85rem',
                                            opacity: 0.7,
                                            marginTop: '-1rem',
                                            marginBottom: '1.5rem'
                                        }}>
                                            Opportunity Gap: {assessment.ewrLoss}%
                                        </div>
                                    )}
                                </div>
                                
                                <div className="narrative-section">
                                    <div className="narrative-label">Tutor Feedback</div>
                                    <div className="narrative-text">{assessment.narrative}</div>
                                </div>
                                
                                {assessment.misconception && (
                                    <div className="misconception-section">
                                        <div className="narrative-label">Misconception Detected</div>
                                        <div className="narrative-text">{assessment.misconception}</div>
                                    </div>
                                )}
                                
                                <div className="assessment-header">
                                    <div className="pick-card yours">
                                        <div className="pick-label">Your Selection</div>
                                        <div className="pick-name">{assessment.yourPick.name}</div>
                                        <div className="pick-rating">{assessment.yourPick.rating}</div>
                                    </div>
                                    <div className="pick-card engine">
                                        <div className="pick-label">Tutor Suggestion</div>
                                        <div className="pick-name">{assessment.enginePick.name}</div>
                                        <div className="pick-rating">{assessment.enginePick.rating}</div>
                                    </div>
                                </div>
                                
                                <div className="rubric-grid">
                                    {Object.entries(assessment.rubric).map(([key, score]) => (
                                        <div key={key} className="rubric-item">
                                            <div className="rubric-label">
                                                {LEARNING_OUTCOMES[key].name}
                                            </div>
                                            <div className="rubric-value">{score}%</div>
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="reflection-prompt">
                                    <div className="narrative-label">Reflection Prompt</div>
                                    <div className="reflection-text">{assessment.reflection}</div>
                                    <input 
                                        className="reflection-input"
                                        value={reflectionResponse}
                                        onChange={e => setReflectionResponse(e.target.value)}
                                        placeholder="Your thoughts..."
                                    />
                                </div>
                                
                                <button className="panel-button" onClick={continueAfterAssessment}>
                                    Apply Learning 
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<DraftSimulator />, document.getElementById('root'));
    </script>
</body>
</html>
